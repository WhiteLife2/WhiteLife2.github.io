<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="study life"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>NDK学习笔记(二) - alonealice</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/earthWo"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://img.zcool.cn/community/014177554b6ae7000001bf729a3698.jpg@1280w_1l_0o_100sh.jpg"><div class="post-title"><h1 class="title">NDK学习笔记(二)</h1><ul class="meta"><li><i class="icon icon-author"></i>alonealice</li><li><i class="icon icon-clock"></i>7 Minutes</li><li><i class="icon icon-calendar"></i>2016年12月26日</li></ul></div></div><div class="article-content" style="max-width:800px"><p>之前的文章中我详细的介绍了第一个NDK程序，后面要讲讲如何使用jni的接口，实现更多的功能。</p>
<h3 id="jstring相关方法"><a href="#jstring相关方法" class="headerlink" title="jstring相关方法"></a>jstring相关方法</h3><p>首先要讲讲jstring相关方法。</p>
<h4 id="NewStringUTF"><a href="#NewStringUTF" class="headerlink" title="NewStringUTF"></a>NewStringUTF</h4><p><code>NewStringUTF</code>函数传入一个字符串，返回jstring对象。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">char p[20]=&quot;hello&quot;;</span><br><span class="line">return env-&gt;NewStringUTF(p);</span><br><span class="line">或者</span><br><span class="line">char *p=&quot;hello&quot;;</span><br><span class="line">return env-&gt;NewStringUTF(p);</span><br><span class="line">或者</span><br><span class="line">std::string hello = &quot;hello&quot;;</span><br><span class="line">return env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">或者</span><br><span class="line">return env-&gt;NewStringUTF(&quot;hello&quot;);</span><br></pre></td></tr></table></figure>
<p>以上4中方式在java层中返回的都是hello。</p>
<h4 id="GetStringLength和GetStringUTFLength"><a href="#GetStringLength和GetStringUTFLength" class="headerlink" title="GetStringLength和GetStringUTFLength"></a>GetStringLength和GetStringUTFLength</h4><p><code>GetStringLength</code>函数顾名思义就是获取jstring的长度，它需要传入一个jstring对象，返回jstring的长度。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">std::string hello=&quot;123456&quot;;</span><br><span class="line">jstring s=env-&gt;NewStringUTF(hello.c_str());</span><br><span class="line">return env-&gt;GetStringLength(s);</span><br><span class="line">//或</span><br><span class="line">return env-&gt;GetStringUTFLength(s);</span><br></pre></td></tr></table></figure>
<p>两个方法的区别是GetStringUTFLength获取jstring的UTF-8编码字符串的长度，而GetStringLength函数是获取Unicode编码的jstring字符串长度。这里的jstring既可以通过内部创建，也可以通过外部java层传入进来，最后java层可以获取到6。</p>
<h4 id="GetStringChars和ReleaseStringChars"><a href="#GetStringChars和ReleaseStringChars" class="headerlink" title="GetStringChars和ReleaseStringChars"></a>GetStringChars和ReleaseStringChars</h4><p><code>GetStringChars</code>函数能将jstring对象转为16位的jchar，而<code>≈</code>则能将内存释放。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jstring s=env-&gt;NewStringUTF(str);  //创建jstring对象</span><br><span class="line">const jchar *p=env-&gt;GetStringChars(s,NULL); //将jstring转为16位jchar</span><br><span class="line">env-&gt;ReleaseStringChars(s,p);//释放内存</span><br></pre></td></tr></table></figure>
<h4 id="GetStringUTFChars和ReleaseStringUTFChars"><a href="#GetStringUTFChars和ReleaseStringUTFChars" class="headerlink" title="GetStringUTFChars和ReleaseStringUTFChars"></a>GetStringUTFChars和ReleaseStringUTFChars</h4><p><code>ReleaseStringUTFChars</code>则是将jstring数据转为字符串，而<code>ReleaseStringUTFChars</code>同样是是否内存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jstring s=env-&gt;NewStringUTF(&quot;hello&quot;);</span><br><span class="line">const char *p=env-&gt;GetStringUTFChars(s,NULL);</span><br><span class="line">env-&gt;ReleaseStringUTFChars(s,p);</span><br></pre></td></tr></table></figure>
<p>最后字符串p的值就是hello</p>
<h3 id="GetStringUTFRegion和GetStringRegion"><a href="#GetStringUTFRegion和GetStringRegion" class="headerlink" title="GetStringUTFRegion和GetStringRegion"></a>GetStringUTFRegion和GetStringRegion</h3><p>这对函数会把源字符串复制到一个预先分配的缓冲区内，然后会获取Unicode和UTF-8编码字符串指定范围内的内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jstring s=env-&gt;NewStringUTF(&quot;hello&quot;);</span><br><span class="line">char p[30]=&quot;123&quot;;</span><br><span class="line">char *t=p+3;</span><br><span class="line">env-&gt;GetStringUTFRegion(s,0,3,t);</span><br><span class="line">return env-&gt;NewStringUTF(p);</span><br></pre></td></tr></table></figure>
<p>这里有几点需要注意一下：首先它需要有一个预先分类号的缓冲区，所以需要先定义一个字符串内存区域，同时把指针指过去，然后在进行赋值，同时，如果这个函数还会做jstring越界检查，如果检查发现越界了，会抛出StringIndexOutOfBoundsException异常。而且由于它不会进行内存分配，所以不需要回收内存。</p>
<h3 id="Array相关方法"><a href="#Array相关方法" class="headerlink" title="Array相关方法"></a>Array相关方法</h3><h4 id="NewTypeArray"><a href="#NewTypeArray" class="headerlink" title="NewTypeArray"></a>NewTypeArray</h4><p>创建固定容量的array数组，如NewIntArray，NewLongArray等。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jintArray array=env-&gt;NewIntArray(3);</span><br><span class="line">return array;</span><br></pre></td></tr></table></figure>
<p>java层能够获取到一个容量为3的int数组。</p>
<h4 id="GetArrayLength"><a href="#GetArrayLength" class="headerlink" title="GetArrayLength"></a>GetArrayLength</h4><p>获取array的长度</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jintArray array=env-&gt;NewIntArray(3);</span><br><span class="line">return env-&gt;GetArrayLength(array);</span><br></pre></td></tr></table></figure>
<p>java层获取到长度3</p>
<h4 id="GetTypeArrayElements"><a href="#GetTypeArrayElements" class="headerlink" title="GetTypeArrayElements"></a>GetTypeArrayElements</h4><p>将jTypeArray转化为jType *，从而可以操作里面的值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jint *as=env-&gt;GetIntArrayElements(array,NULL);</span><br><span class="line">as[0]=20;</span><br><span class="line">return as[0];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">java层：</span><br><span class="line">public static int[] intarray=&#123;10,4,54&#125;;</span><br><span class="line">JavaHelper.createArray(JavaHelper.intarray);</span><br><span class="line">最后java层获取到的值为20</span><br></pre></td></tr></table></figure>
<h4 id="GetPrimitiveTypeArrayRegion"><a href="#GetPrimitiveTypeArrayRegion" class="headerlink" title="GetPrimitiveTypeArrayRegion"></a>GetPrimitiveTypeArrayRegion</h4><p>将部分typearray数据复制到type数组</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jint nativeArray[3];</span><br><span class="line">env-&gt;GetIntArrayRegion(array,0,3,nativeArray);</span><br><span class="line">for(int i=0;i&lt;3;i++)&#123;</span><br><span class="line">   nativeArray[i]+=9;</span><br><span class="line">&#125;</span><br><span class="line">return nativeArray[0];</span><br><span class="line"></span><br><span class="line">java层传入&#123;1,2,3&#125;</span><br><span class="line">返回10</span><br></pre></td></tr></table></figure>
<h4 id="SetTypeArrayRegion"><a href="#SetTypeArrayRegion" class="headerlink" title="SetTypeArrayRegion"></a>SetTypeArrayRegion</h4><p>将type数组转化为jtypeArray</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jint nativeArray[3];</span><br><span class="line">env-&gt;GetIntArrayRegion(array,0,3,nativeArray);</span><br><span class="line">for(int i=0;i&lt;3;i++)&#123;</span><br><span class="line">   nativeArray[i]+=9;</span><br><span class="line">&#125;</span><br><span class="line">env-&gt;SetIntArrayRegion(array,0,3,nativeArray);</span><br><span class="line">return array;</span><br><span class="line"></span><br><span class="line">java层输入&#123;1,2,3,4,5&#125;，返回&#123;10,11,12,4,5&#125;</span><br></pre></td></tr></table></figure></div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ndk/">ndk</a><span class="tag-list-count">4</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ndk/">ndk</a><span class="category-list-count">4</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="ck85r4tdf0018c7o19hw4vpzz" data-title="NDK学习笔记(二)" data-url="https://earthwo.github.io/2016/12/26/NDK学习笔记-二/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2017/01/07/NDK学习笔记-三/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2016/12/24/jni学习笔记/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/earthWo" title="Github" target="_blank"><i class="icon icon-github"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2020 alonealice<br><small><a href="http://www.miitbeian.gov.cn/" target="_blank">浙ICP备17033688号</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>