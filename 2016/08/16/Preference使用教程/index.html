<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description" content="study life"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>Preference使用教程 - alonealice</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/earthWo"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="https://img.zcool.cn/community/014177554b6ae7000001bf729a3698.jpg@1280w_1l_0o_100sh.jpg"><div class="post-title"><h1 class="title">Preference使用教程</h1><ul class="meta"><li><i class="icon icon-author"></i>alonealice</li><li><i class="icon icon-clock"></i>18 Minutes</li><li><i class="icon icon-calendar"></i>2016年8月16日</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这几天在看书时，意外地看到了Preference框架。相对于IOS SDK，这个功能在创建设置界面时会更加容易一点。开发者只需要编辑一个简单的xml文件，<br>就能开发出一个简单的设置界面。我在网上找了一些资料，看到这些资料都只是简单的介绍了这个功能的使用，不够具体时间上也比较早。现在我就详细的介绍一下它的使用。</p>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>在Android手机中都有设置功能，许多的android应用也有相应的设置界面允许用户修改应用特性和行为。在为这些应用提供设置 功能时，开发者应该使  Android的Preference API构建一个与其他Android应用中的用户体验一致的界面（包括系统设置）。</p>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>设置是使用在XML文件中声明的 Preference 类的各种子类构建而成，而不是使用View对象构建用户界面。<br>Preference 对象是单个设置的构建基块。每个Preference都有一个相应的键值对，可供系统用来将设置保存在应用设置的默认SharedPreferences文件中。当用户更改设置时，系统会自动更新SharedPreferences文件中的相应值。开发者只应在需要读取值以根据用户设置确定应用的行为时，才与关联的 SharedPreferences文件直接交互。<br>保存在SharedPreferences中的值主要是以下数据类型：<br>1.布尔型<br>2.浮点型<br>3.整型<br>4.长整型<br>5.字符串<br>6.字符串 Set<br>同时，开发者还需要专门的Activity和Fragment子类来显示UI。在3.0之前的Android版本中，开发者必须使用继承PreferenceActivity的activity；在3.0及更高的版本中，开发者可以使用普通的activity，同时使用继承PreferenceFragment的Fragment。如果需要多组设置，则可以使用PreferenceActivity为大屏幕创建双窗格布局。</p>
<h2 id="首选项"><a href="#首选项" class="headerlink" title="首选项"></a>首选项</h2><p>Preference 对象是单个设置的构建基块，而其他的应用设置都是Preference的子类表示。每个子类都可以指定标题和默认值等内容，同时也有自己特定的属性和用户界面。最常用的首选项如下：<br>CheckBoxPreference:CheckBoxPreference 可创建一个列表项用于显示复选框，显示一个包含已启用或已禁用设置复选框的项目。<br>ListPreference:ListPreference 可创建一个项目用于打开包含选择列表的对话框,打开一个包含单选按钮列表的对话框。保存的值可以是任一受支持的值类型。<br>EditTextPreference:打开一个包含 EditText 小工具的对话框。<br>DialogPreference：打开一个dialog对话框。<br>MultiSelectListPreference：打开一个包含多选按钮列表的对话框。<br>SwitchPreference：一个switch选择器。</p>
<h2 id="使用-XML-定义首选项"><a href="#使用-XML-定义首选项" class="headerlink" title="使用 XML 定义首选项"></a>使用 XML 定义首选项</h2><p>开发者开始在运行时直接实例化新的Preference对象，但是一般情况下，还是应该在XML文件中定义设置列表。这样更容易阅读和查看。<br><em>XML文件必须保存在 res/xml/ 目录中。</em> XML文件中的根节点必须是<preferencescreen>元素，在<preferencescreen>元素中可以添加任意的preference元素，每一个子项都会显示在设置列表中。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;EditTextPreference</span><br><span class="line">  android:key=&quot;edit_preference&quot;</span><br><span class="line">  android:title=&quot;输入框&quot;</span><br><span class="line">  android:summary=&quot;输入框&quot;/&gt;</span><br><span class="line"></span><br><span class="line">&lt;CheckBoxPreference</span><br><span class="line">  android:key=&quot;checkbox_preference&quot;</span><br><span class="line">  android:title=&quot;开关&quot;</span><br><span class="line">  android:summary=&quot;开关按钮&quot;</span><br><span class="line">  android:defaultValue=&quot;true&quot; /&gt;</span><br></pre></td></tr></table></figure></preferencescreen></preferencescreen></p>
<p>在此示例中，两个项有3个共同的属性：<br>1.android:key：对于要保留数据值的首选项，必须拥有此属性。它指定系统在将此设置的值保存在 SharedPreferences 中时所用的唯一键（字符串）。<br>2.android:title：此属性为设置提供用户可见的名称。<br>3.android:summary：此属性为设置提供用户可见的概述。</p>
<h2 id="使用设置组"><a href="#使用设置组" class="headerlink" title="使用设置组"></a>使用设置组</h2><p>如果开发者的设置列表中需要的设置选项比较多时，开发者可以使用设置组来进行分组，方便用户浏览、理解和处理设置。设置组可以有效的将一个长列表转化成多个段列表，方法有以下两种：</p>
<ul>
<li><h4 id="使用标题"><a href="#使用标题" class="headerlink" title="使用标题"></a>使用标题</h4><p>以分隔线分隔两组设置并为其提供标题，将每组 Preference 对象放入 PreferenceCategory 内。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;PreferenceScreen xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line">&lt;PreferenceCategory</span><br><span class="line">  android:title=&quot;主要组件&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;EditTextPreference</span><br><span class="line">    android:key=&quot;edit_preference&quot;</span><br><span class="line">    android:title=&quot;输入框&quot;</span><br><span class="line">    android:summary=&quot;输入框&quot;/&gt;</span><br><span class="line"></span><br><span class="line">  &lt;CheckBoxPreference</span><br><span class="line">    android:key=&quot;checkbox_preference&quot;</span><br><span class="line">    android:title=&quot;开关&quot;</span><br><span class="line">    android:summary=&quot;开关按钮&quot;</span><br><span class="line">    android:defaultValue=&quot;true&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/PreferenceCategory&gt;</span><br><span class="line">&lt;/PreferenceScreen&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><h4 id="使用子屏幕"><a href="#使用子屏幕" class="headerlink" title="使用子屏幕"></a>使用子屏幕</h4><p>将设置或设置组放入到子屏幕,点击时会跳转到子屏幕显示。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;PreferenceScreen xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line">      &lt;PreferenceScreen</span><br><span class="line">          android:key=&quot;button_voicemail_setting_key&quot;</span><br><span class="line">          android:title=&quot;子页面&quot;</span><br><span class="line">          android:persistent=&quot;false&quot;&gt;</span><br><span class="line">          &lt;Preference</span><br><span class="line">              android:summary=&quot;子页面文本框&quot;</span><br><span class="line">              android:title=&quot;子页面文本框&quot;</span><br><span class="line">              android:dependency=&quot;list_preference&quot;</span><br><span class="line">              android:key=&quot;text_preference&quot;&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/Preference&gt;</span><br><span class="line">      &lt;/PreferenceScreen&gt;</span><br><span class="line">&lt;/PreferenceScreen&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用-Intent-跳转"><a href="#使用-Intent-跳转" class="headerlink" title="使用 Intent 跳转"></a>使用 Intent 跳转</h2><p>在特殊情况，应用需要在设置页面跳转到应用的其他页面。所以要在用户选择首选项时调用Intent，需要在相应的Preference元素中添加intent。添加的intent的可以分为隐式和显式。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;Preference android:title=&quot;intent&quot; &gt;</span><br><span class="line">    &lt;intent android:action=&quot;android.intent.action.VIEW&quot;</span><br><span class="line">            android:data=&quot;http://www.google.com&quot; /&gt;</span><br><span class="line">&lt;/Preference&gt;</span><br><span class="line">&lt;Preference android:title=&quot;intent&quot; &gt;</span><br><span class="line">    &lt;intent android:targetClass=&quot;com.orange.studydemo.SecondActivity&quot;</span><br><span class="line">           android:targetPackage=&quot;com.orange.studydemo&quot;/&gt;</span><br><span class="line">&lt;/Preference&gt;</span><br></pre></td></tr></table></figure></p>
<p>intent可以添加一下属性：<br>android:action：要分配的操作（按照 setAction() 方法）。<br>android:data：要分配的数据（按照 setData() 方法）。<br>android:mimeType：要分配的 MIME 类型（按照 setType() 方法）。<br>android:targetClass：组件名称的类部分（按照 setComponent() 方法）。<br>android:targetPackage：组件名称的软件包部分（按照 setComponent() 方法）。</p>
<h2 id="创建首选项的-Activity-和-Fragment"><a href="#创建首选项的-Activity-和-Fragment" class="headerlink" title="创建首选项的 Activity 和 Fragment"></a>创建首选项的 Activity 和 Fragment</h2><p>在XML文件配置完成之后，要在Activity中显式设置，需要扩展PreferenceActivity类。该类会根据自动保留每个Preference相关的设置。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SettingsActivity extends PreferenceActivity &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        addPreferencesFromResource(R.xml.preferences);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在Android3.0及更高的版本中，应该使用PreferenceFragment来代替PreferenceActivity的使用。在PreferenceFragment中使用与在PreferenceActivity中使用基本一样。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public static class SettingsFragment extends PreferenceFragment &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line">        addPreferencesFromResource(R.xml.preferences);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时需要在Activity中添加Fragment，代码如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SettingsActivity extends Activity &#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">        getFragmentManager().beginTransaction()</span><br><span class="line">                .replace(android.R.id.content, new SettingsFragment())</span><br><span class="line">                .commit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="设置默认值"><a href="#设置默认值" class="headerlink" title="设置默认值"></a>设置默认值</h2><p>在很多情况下，我们需要在用户第一次打开应用时就有默认值。所以需要对相应的Preference设置默认值。<br>设置默认值需要在XML文件中对Preference设置  android:defaultValue 属性。不同的 Preference 的默认值类型页不一样，比如CheckBoxPreference 的默认值是布尔值，而 ListPreference 的默认值类型是string。</p>
<p><strong>然后需要在应用的主activity（设置为 <action android:name="android.intent.action.MAIN">的activity）中的oncreate()方法中调用setDefaultValues（）方法</action></strong><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PreferenceManager.setDefaultValues(this,R.xml.main_activity,false);</span><br></pre></td></tr></table></figure></p>
<p>其中第三个参数表示是否多次设置默认值。如果第三个参数设置为false，则应用只有在第一次调用activity时会设置默认值，如果设置为true，则每次应用打开时都会将值设置为默认值。</p>
<h2 id="使用首选项标头"><a href="#使用首选项标头" class="headerlink" title="使用首选项标头"></a>使用首选项标头</h2><p>在大显示屏尤其是pad情况下，我们应该使用标头功能，而不是使用嵌套功能。使用标头功能的好处是在大屏幕上，preferenceActivity会自动提供双窗口显示。如下图：</p>
<p><img src="http://7xjrms.com1.z0.glb.clouddn.com/settingsscreen-650-80.jpg" alt><br>而在小屏幕中则与嵌套差不多。<br>使用标头构建设置的方法：</p>
<ul>
<li><h4 id="创建多个PreferenceFragment实例，每个实例都需要一个单独的XML文件。"><a href="#创建多个PreferenceFragment实例，每个实例都需要一个单独的XML文件。" class="headerlink" title="创建多个PreferenceFragment实例，每个实例都需要一个单独的XML文件。"></a>创建多个PreferenceFragment实例，每个实例都需要一个单独的XML文件。</h4></li>
<li><h4 id="创建XML标头文件，其中每个设置都要对应一个相应的fragment。"><a href="#创建XML标头文件，其中每个设置都要对应一个相应的fragment。" class="headerlink" title="创建XML标头文件，其中每个设置都要对应一个相应的fragment。"></a>创建XML标头文件，其中每个设置都要对应一个相应的fragment。</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;preference-headers xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line">    &lt;header</span><br><span class="line">        android:fragment=&quot;com.example.prefs.SettingsActivity$SettingsFragmentOne&quot;</span><br><span class="line">        android:title=&quot;标头1&quot;</span><br><span class="line">        android:summary=&quot;标头1&quot; /&gt;</span><br><span class="line">    &lt;header</span><br><span class="line">        android:fragment=&quot;com.example.prefs.SettingsActivity$SettingsFragmentTwo&quot;</span><br><span class="line">        android:title=&quot;标头2&quot;</span><br><span class="line">        android:summary=&quot;标头2&quot; &gt;</span><br><span class="line">        &lt;extra android:name=&quot;someKey&quot; android:value=&quot;someHeaderValue&quot; /&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">&lt;/preference-headers&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在元素中可以使用bundle传递其他参数，在片段中可以使用getArgument()来获取参数，从而根据不同的参数使用同一个fragment加载不同的xml文件。</p>
<ul>
<li><h4 id="将activity继承PreferenceActivity，并且实现onBuildHeaders-方法来显示标头，同时需要重写isValidFragment方法，对可以使用的fragment返回true。"><a href="#将activity继承PreferenceActivity，并且实现onBuildHeaders-方法来显示标头，同时需要重写isValidFragment方法，对可以使用的fragment返回true。" class="headerlink" title="将activity继承PreferenceActivity，并且实现onBuildHeaders()方法来显示标头，同时需要重写isValidFragment方法，对可以使用的fragment返回true。"></a>将activity继承PreferenceActivity，并且实现onBuildHeaders()方法来显示标头，同时需要重写isValidFragment方法，对可以使用的fragment返回true。</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public class SettingsActivity extends PreferenceActivity &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onBuildHeaders(List&lt;Header&gt; target) &#123;</span><br><span class="line">        loadHeadersFromResource(R.xml.preference_headers, target);</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isValidFragment(String fragmentName) &#123;</span><br><span class="line">       return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>由于header是在android3.0之后添加的新功能，所以如果要兼容3.0之前的版本，我们需要在使用前文介绍的嵌套功能进行兼容。<br>activity主要的代码如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">    super.onCreate(savedInstanceState);</span><br><span class="line">    if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.HONEYCOMB) &#123;</span><br><span class="line">        addPreferencesFromResource(R.xml.preference_headers_legacy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void onBuildHeaders(List&lt;Header&gt; target) &#123;</span><br><span class="line">   loadHeadersFromResource(R.xml.preference_headers, target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="读取和监听首选项的变化"><a href="#读取和监听首选项的变化" class="headerlink" title="读取和监听首选项的变化"></a>读取和监听首选项的变化</h2><ul>
<li><p>读取首选项<br>默认情况下，应用的所有首选项均保存到一个文件中，该文件可以通过调用静态方法 PreferenceManager.getDefaultSharedPreferences()，从应用内的任何位置访问。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SharedPreferences sharedPref = PreferenceManager.</span><br><span class="line">getDefaultSharedPreferences(this);</span><br><span class="line">String value = sharedPref.getString(key, defaultValue);</span><br></pre></td></tr></table></figure>
</li>
<li><p>监听首选项变化<br>要在任一首选项发生更改时收到回调，Activity需要实现 SharedPreference.<br>OnSharedPreferenceChangeListener 接口，并通过调用 registerOnSharedPreferenceChangeListener() 为 SharedPreferences 对象注册侦听器。<br>该接口只有 onSharedPreferenceChanged() 一种回调方法，在回调中可以获取变化的Preference和相应的值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public void onSharedPreferenceChanged(SharedPreferences sharedPreferences,String key) &#123;</span><br><span class="line">       if (key.equals(&quot;key&quot;)) &#123;</span><br><span class="line">           Preference preference = findPreference(key);        </span><br><span class="line">           String value=sharedPreferences.getString(key, &quot;&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>为了能够保证侦听器不被当做垃圾回收，我们最好在 onResume() 和 onPause() 回调期间分别注册和注销<br>SharedPreferences.<br>OnSharedPreferenceChangeListener。<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@Override</span><br><span class="line">protected void onResume() &#123;</span><br><span class="line">    super.onResume();</span><br><span class="line">    getPreferenceScreen().getSharedPreferences()</span><br><span class="line">            .registerOnSharedPreferenceChangeListener(this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">protected void onPause() &#123;</span><br><span class="line">    super.onPause();</span><br><span class="line">    getPreferenceScreen().getSharedPreferences()</span><br><span class="line">            .unregisterOnSharedPreferenceChangeListener(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</div><div class="article-meta" style="max-width:800px"><div class="tags"><i class="icon icon-tag"></i><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Preference/">Preference</a><span class="tag-list-count">1</span></li></ul></div><div class="categories"><i class="icon icon-category"></i><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Preference/">Preference</a><span class="category-list-count">1</span></li></ul></div></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="ck85r7lur007ifxo1z157l4sk" data-title="Preference使用教程" data-url="https://earthwo.github.io/2016/08/16/Preference使用教程/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2016/09/07/HanlderThread/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2016/08/04/IntentService解析/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/earthWo" title="Github" target="_blank"><i class="icon icon-github"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2020 alonealice<br><small><a href="http://www.beian.miit.gov.cn" target="_blank">浙ICP备17033688号</a></small><small>, THEME BY <a href="https://github.com/BoizZ/hexo-theme-laughing" target="_blank">LAUGHING</a></small></p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>