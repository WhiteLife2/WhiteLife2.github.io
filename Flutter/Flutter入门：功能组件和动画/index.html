<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="不懂要会问，打脸要立正">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          Flutter入门：功能组件和动画 - alonealice | Blog
        
    </title>

    <link rel="canonical" href="http://alonealice.com/Flutter/Flutter入门：功能组件和动画/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/article_header/article_bg.jpeg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Flutter" title="Flutter">Flutter</a>
                            
                        </div>
                        <h1>Flutter入门：功能组件和动画</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by alonealice on
                            2021-01-05
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">alonealice</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="功能型组件">功能型组件</h2>
<h3 id="导航返回拦截">导航返回拦截</h3>
<p>Flutter中可以通过<code>WillPopScope</code>来实现返回按钮拦截</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WillPopScope(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="meta">@required</span> WillPopCallback onWillPop,</span><br><span class="line">  <span class="meta">@required</span> Widget child</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>onWillPop</code>是一个回调函数，当用户点击返回按钮时被调用（包括导航返回按钮及Android物理返回按钮）。该回调需要返回一个<code>Future</code>对象，如果返回的<code>Future</code>最终值为<code>false</code>时，则当前路由不出栈(不会返回)；最终值为<code>true</code>时，当前路由出栈退出。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line"> Widget build(BuildContext context) &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> WillPopScope(</span><br><span class="line">       onWillPop: () <span class="keyword">async</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (_lastPressedAt == <span class="keyword">null</span> ||</span><br><span class="line">             <span class="built_in">DateTime</span>.now().difference(_lastPressedAt) &gt; <span class="built_in">Duration</span>(seconds: <span class="number">1</span>)) &#123;</span><br><span class="line">           <span class="comment">//两次点击间隔超过1秒则重新计时</span></span><br><span class="line">           _lastPressedAt = <span class="built_in">DateTime</span>.now();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;,</span><br><span class="line">       child: Container(</span><br><span class="line">         alignment: Alignment.center,</span><br><span class="line">         child: Text(<span class="string">"1秒内连续按两次返回键退出"</span>),</span><br><span class="line">       )</span><br><span class="line">   );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="数据共享inheritedwidget">数据共享（InheritedWidget）</h3>
<p><code>InheritedWidget</code>是Flutter中非常重要的一个功能型组件，它提供了一种数据在widget树中从上到下传递、共享的方式，比如我们在应用的根widget中通过<code>InheritedWidget</code>共享了一个数据，那么我们便可以在任意子widget中来获取该共享的数据！Flutter SDK中正是通过InheritedWidget来共享应用主题（<code>Theme</code>）和Locale (当前语言环境)信息的。</p>
<h4 id="didchangedependencies">didChangeDependencies</h4>
<p>在之前介绍<code>StatefulWidget</code>时，我们提到<code>State</code>对象有一个<code>didChangeDependencies</code>回调，它会在“依赖”发生变化时被Flutter Framework调用。这个“依赖”指的就是子widget是否使用了父widget中<code>InheritedWidget</code>的数据！这种机制可以使子组件在所依赖的<code>InheritedWidget</code>变化时来更新自身！比如当主题、locale(语言)等发生变化时，依赖其的子widget的<code>didChangeDependencies</code>方法将会被调用。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShareDataWidget</span> <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  ShareDataWidget(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.data,</span><br><span class="line">    Widget child</span><br><span class="line">  &#125;) :<span class="keyword">super</span>(child: child);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> data; <span class="comment">//需要在子树中共享的数据，保存点击次数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//定义一个便捷方法，方便子树中的widget获取共享数据  </span></span><br><span class="line">  <span class="keyword">static</span> ShareDataWidget of(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;ShareDataWidget&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//该回调决定当data发生变化时，是否通知子树中依赖data的Widget  </span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(ShareDataWidget old) &#123;</span><br><span class="line">    <span class="comment">//如果返回true，则子树中依赖(build函数中有调用)本widget</span></span><br><span class="line">    <span class="comment">//的子widget的`state.didChangeDependencies`会被调用</span></span><br><span class="line">    <span class="keyword">return</span> old.data != data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般来说，子widget很少会重写此方法，因为在依赖改变后framework也都会调用<code>build()</code>方法。但是，如果你需要在依赖改变后执行一些昂贵的操作，比如网络请求，这时最好的方式就是在此方法中执行，这样可以避免每次<code>build()</code>都执行这些昂贵操作。</p>
<h3 id="跨组件状态共享provider">跨组件状态共享（Provider）</h3>
<p>组件私有的状态管理方式就比较多，如使用全局事件总线EventBus，还有就是InheritedWidget。Flutter社区著名的Provider包正是基于这个思想实现的一套跨组件状态共享解决方案。</p>
<p>现在Flutter社区已经有很多专门用于状态管理的包了，在此我们列出几个相对评分比较高的：</p>
<table>
<thead>
<tr>
<th>包名</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://pub.flutter-io.cn/packages/provider" target="_blank" rel="noopener">Provider</a> &amp; <a href="https://pub.flutter-io.cn/packages/scoped_model" target="_blank" rel="noopener">Scoped Model</a></td>
<td>这两个包都是基于<code>InheritedWidget</code>的，原理相似</td>
</tr>
<tr>
<td><a href="https://pub.flutter-io.cn/packages/flutter_redux" target="_blank" rel="noopener">Redux</a></td>
<td>是Web开发中React生态链中Redux包的Flutter实现</td>
</tr>
<tr>
<td><a href="https://pub.dev/packages/flutter_mobx" target="_blank" rel="noopener">MobX</a></td>
<td>是Web开发中React生态链中MobX包的Flutter实现</td>
</tr>
<tr>
<td><a href="https://pub.dev/packages/flutter_bloc" target="_blank" rel="noopener">BLoC</a></td>
<td>是BLoC模式的Flutter实现</td>
</tr>
</tbody>
</table>
<h3 id="颜色和主题">颜色和主题</h3>
<h4 id="颜色">颜色</h4>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Color(<span class="number">0xffdc380d</span>); <span class="comment">//如果颜色固定可以直接使用整数值</span></span><br><span class="line"><span class="comment">//颜色是一个字符串变量</span></span><br><span class="line"><span class="keyword">var</span> c = <span class="string">"dc380d"</span>;</span><br><span class="line">Color(<span class="built_in">int</span>.parse(c,radix:<span class="number">16</span>)|<span class="number">0xFF000000</span>) <span class="comment">//通过位运算符将Alpha设置为FF</span></span><br><span class="line">Color(<span class="built_in">int</span>.parse(c,radix:<span class="number">16</span>)).withAlpha(<span class="number">255</span>)  <span class="comment">//通过方法将Alpha设置为FF</span></span><br></pre></td></tr></table></figure>
<p><strong>颜色亮度：</strong> Color类中提供了一个<code>computeLuminance()</code>方法，它可以返回一个[0-1]的一个值，数字越大颜色就越浅，我们可以根据它来动态确定Title的颜色。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">color: color.computeLuminance() &lt; <span class="number">0.5</span> ? Colors.white : Colors.black,</span><br></pre></td></tr></table></figure>
<h5 id="materialcolor">MaterialColor</h5>
<p><code>MaterialColor</code>是实现Material Design中的颜色的类，它包含一种颜色的10个级别的渐变色。<code>MaterialColor</code>通过&quot;[]&quot;运算符的索引值来代表颜色的深度，有效的索引有：50，100，200，…，900，数字越大，颜色越深。</p>
<p><code>Colors.blue</code>是预定义的一个<code>MaterialColor</code>类对象，定义如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> MaterialColor blue = MaterialColor(</span><br><span class="line">  _bluePrimaryValue,</span><br><span class="line">  &lt;<span class="built_in">int</span>, Color&gt;&#123;</span><br><span class="line">     <span class="number">50</span>: Color(<span class="number">0xFFE3F2FD</span>),</span><br><span class="line">    <span class="number">100</span>: Color(<span class="number">0xFFBBDEFB</span>),</span><br><span class="line">    <span class="number">200</span>: Color(<span class="number">0xFF90CAF9</span>),</span><br><span class="line">    <span class="number">300</span>: Color(<span class="number">0xFF64B5F6</span>),</span><br><span class="line">    <span class="number">400</span>: Color(<span class="number">0xFF42A5F5</span>),</span><br><span class="line">    <span class="number">500</span>: Color(_bluePrimaryValue),</span><br><span class="line">    <span class="number">600</span>: Color(<span class="number">0xFF1E88E5</span>),</span><br><span class="line">    <span class="number">700</span>: Color(<span class="number">0xFF1976D2</span>),</span><br><span class="line">    <span class="number">800</span>: Color(<span class="number">0xFF1565C0</span>),</span><br><span class="line">    <span class="number">900</span>: Color(<span class="number">0xFF0D47A1</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">int</span> _bluePrimaryValue = <span class="number">0xFF2196F3</span>;</span><br></pre></td></tr></table></figure>
<p><code>Colors.blue[50]</code>到<code>Colors.blue[900]</code>的色值从浅蓝到深蓝渐变。</p>
<h4 id="theme">Theme</h4>
<p><code>Theme</code>组件可以为Material APP定义主题数据（ThemeData）。Material组件库里很多组件都使用了主题数据，如导航栏颜色、标题字体、Icon样式等。<code>Theme</code>内会使用<code>InheritedWidget</code>来为其子树共享样式数据。</p>
<p><code>ThemeData</code>用于保存是Material 组件库的主题数据，我们可以通过ThemeData来自定义应用主题。在子组件中，我们可以通过<code>Theme.of</code>方法来获取当前的<code>ThemeData</code>。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ThemeData(&#123;</span><br><span class="line">  Brightness brightness, <span class="comment">//深色还是浅色</span></span><br><span class="line">  MaterialColor primarySwatch, <span class="comment">//主题颜色样本，见下面介绍</span></span><br><span class="line">  Color primaryColor, <span class="comment">//主色，决定导航栏颜色</span></span><br><span class="line">  Color accentColor, <span class="comment">//次级色，决定大多数Widget的颜色，如进度条、开关等。</span></span><br><span class="line">  Color cardColor, <span class="comment">//卡片颜色</span></span><br><span class="line">  Color dividerColor, <span class="comment">//分割线颜色</span></span><br><span class="line">  ButtonThemeData buttonTheme, <span class="comment">//按钮主题</span></span><br><span class="line">  Color cursorColor, <span class="comment">//输入框光标颜色</span></span><br><span class="line">  Color dialogBackgroundColor,<span class="comment">//对话框背景颜色</span></span><br><span class="line">  <span class="built_in">String</span> fontFamily, <span class="comment">//文字字体</span></span><br><span class="line">  TextTheme textTheme,<span class="comment">// 字体主题，包括标题、body等文字样式</span></span><br><span class="line">  IconThemeData iconTheme, <span class="comment">// Icon的默认样式</span></span><br><span class="line">  TargetPlatform platform, <span class="comment">//指定平台，应用特定平台控件风格</span></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line"> Widget build(BuildContext context) &#123;</span><br><span class="line">   ThemeData themeData = Theme.of(context);</span><br><span class="line">   <span class="keyword">return</span> Theme(</span><br><span class="line">     data: ThemeData(</span><br><span class="line">         primarySwatch: _themeColor, <span class="comment">//用于导航栏、FloatingActionButton的背景色等</span></span><br><span class="line">         iconTheme: IconThemeData(color: _themeColor) <span class="comment">//用于Icon颜色</span></span><br><span class="line">     ),</span><br><span class="line">     child: Scaffold(</span><br><span class="line">       appBar: AppBar(title: Text(<span class="string">"主题测试"</span>)),</span><br><span class="line">       body: Column(</span><br><span class="line">         mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">         children: &lt;Widget&gt;[</span><br><span class="line">           <span class="comment">//第一行Icon使用主题中的iconTheme</span></span><br><span class="line">           Row(</span><br><span class="line">               mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">               children: &lt;Widget&gt;[</span><br><span class="line">                 Icon(Icons.favorite),</span><br><span class="line">                 Icon(Icons.airport_shuttle),</span><br><span class="line">                 Text(<span class="string">"  颜色跟随主题"</span>)</span><br><span class="line">               ]</span><br><span class="line">           ),</span><br><span class="line">           <span class="comment">//为第二行Icon自定义颜色（固定为黑色)</span></span><br><span class="line">           Theme(</span><br><span class="line">             data: themeData.copyWith(</span><br><span class="line">               iconTheme: themeData.iconTheme.copyWith(</span><br><span class="line">                   color: Colors.black</span><br><span class="line">               ),</span><br><span class="line">             ),</span><br><span class="line">             child: Row(</span><br><span class="line">                 mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                 children: &lt;Widget&gt;[</span><br><span class="line">                   Icon(Icons.favorite),</span><br><span class="line">                   Icon(Icons.airport_shuttle),</span><br><span class="line">                   Text(<span class="string">"  颜色固定黑色"</span>)</span><br><span class="line">                 ]</span><br><span class="line">             ),</span><br><span class="line">           ),</span><br><span class="line">         ],</span><br><span class="line">       ),</span><br><span class="line">       floatingActionButton: FloatingActionButton(</span><br><span class="line">           onPressed: () =&gt;  <span class="comment">//切换主题</span></span><br><span class="line">               setState(() =&gt;</span><br><span class="line">               _themeColor =</span><br><span class="line">               _themeColor == Colors.teal ? Colors.blue : Colors.teal</span><br><span class="line">               ),</span><br><span class="line">           child: Icon(Icons.palette)</span><br><span class="line">       ),</span><br><span class="line">     ),</span><br><span class="line">   );</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的有三点：</p>
<ul>
<li>
<p>可以通过局部主题覆盖全局主题，正如代码中通过Theme为第二行图标指定固定颜色（黑色）一样，这是一种常用的技巧，Flutter中会经常使用这种方法来自定义子树主题。那么为什么局部主题可以覆盖全局主题？这主要是因为widget中使用主题样式时是通过<code>Theme.of(BuildContext context)</code>来获取的，我们看看其简化后的代码：</p>
</li>
<li>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ThemeData of(BuildContext context, &#123; <span class="built_in">bool</span> shadowThemeOnly = <span class="keyword">false</span> &#125;) &#123;</span><br><span class="line">   <span class="comment">// 简化代码，并非源码  </span></span><br><span class="line">   <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;_InheritedTheme&gt;().theme.data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>context.dependOnInheritedWidgetOfExactType</code> 会在widget树中从当前位置向上查找第一个类型为<code>_InheritedTheme</code>的widget。所以当局部指定<code>Theme</code>后，其子树中通过<code>Theme.of()</code>向上查找到的第一个<code>_InheritedTheme</code>便是我们指定的<code>Theme</code>。</p>
</li>
<li>
<p>本示例是对单个路由换肤，如果想要对整个应用换肤，则可以去修改<code>MaterialApp</code>的<code>theme</code>属性。</p>
</li>
</ul>
<h3 id="异步ui更新">异步UI更新</h3>
<p>很多时候我们会依赖一些异步数据来动态更新UI，因此Flutter专门提供了<code>FutureBuilder</code>和<code>StreamBuilder</code>两个组件来快速实现这种功能。</p>
<h4 id="futurebuilder">FutureBuilder</h4>
<p>下<code>FutureBuilder</code>构造函数：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FutureBuilder(&#123;</span><br><span class="line">  <span class="keyword">this</span>.future,</span><br><span class="line">  <span class="keyword">this</span>.initialData,</span><br><span class="line">  <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p><code>future</code>：<code>FutureBuilder</code>依赖的<code>Future</code>，通常是一个异步耗时任务。</p>
</li>
<li>
<p><code>initialData</code>：初始数据，用户设置默认数据。</p>
</li>
<li>
<p><code>builder</code>：Widget构建器；该构建器会在<code>Future</code>执行的不同阶段被多次调用，构建器签名如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span> (BuildContext context, AsyncSnapshot snapshot)</span><br></pre></td></tr></table></figure>
<p><code>snapshot</code>会包含当前异步任务的状态信息及结果信息 ，比如我们可以通过<code>snapshot.connectionState</code>获取异步任务的状态信息、通过<code>snapshot.hasError</code>判断异步任务是否有错误等等，完整的定义读者可以查看<code>AsyncSnapshot</code>类定义。</p>
<p>另外，<code>FutureBuilder</code>的<code>builder</code>函数签名和<code>StreamBuilder</code>的<code>builder</code>是相同的。</p>
</li>
</ul>
<p>举例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">String</span>&gt; mockNetworkData() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">2</span>), () =&gt; <span class="string">"我是从互联网上获取的数据"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Center(</span><br><span class="line">    child: FutureBuilder&lt;<span class="built_in">String</span>&gt;(</span><br><span class="line">      future: mockNetworkData(),</span><br><span class="line">      builder: (BuildContext context, AsyncSnapshot snapshot) &#123;</span><br><span class="line">        <span class="comment">// 请求已结束</span></span><br><span class="line">        <span class="keyword">if</span> (snapshot.connectionState == ConnectionState.done) &#123;</span><br><span class="line">          <span class="keyword">if</span> (snapshot.hasError) &#123;</span><br><span class="line">            <span class="comment">// 请求失败，显示错误</span></span><br><span class="line">            <span class="keyword">return</span> Text(<span class="string">"Error: <span class="subst">$&#123;snapshot.error&#125;</span>"</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 请求成功，显示数据</span></span><br><span class="line">            <span class="keyword">return</span> Text(<span class="string">"Contents: <span class="subst">$&#123;snapshot.data&#125;</span>"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 请求未结束，显示loading</span></span><br><span class="line">          <span class="keyword">return</span> CircularProgressIndicator();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ConnectionState &#123;</span><br><span class="line">  <span class="comment">/// 当前没有异步任务，比如[FutureBuilder]的[future]为null时</span></span><br><span class="line">  none,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 异步任务处于等待状态</span></span><br><span class="line">  waiting,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// Stream处于激活状态（流上已经有数据传递了），对于FutureBuilder没有该状态。</span></span><br><span class="line">  active,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// 异步任务已经终止.</span></span><br><span class="line">  done,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="streambuilder">StreamBuilder</h4>
<p><code>treamBuilder</code>正是用于配合<code>Stream</code>来展示流上事件（数据）变化的UI组件。下面看一下<code>StreamBuilder</code>的默认构造函数：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">StreamBuilder(&#123;</span><br><span class="line">  Key key,</span><br><span class="line">  <span class="keyword">this</span>.initialData,</span><br><span class="line">  Stream&lt;T&gt; stream,</span><br><span class="line">  <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;<span class="built_in">int</span>&gt; counter() &#123;</span><br><span class="line">  <span class="keyword">return</span> Stream.periodic(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>), (i) &#123;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">   <span class="keyword">return</span> StreamBuilder&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">     stream: counter(), <span class="comment">//</span></span><br><span class="line">     <span class="comment">//initialData: ,// a Stream&lt;int&gt; or null</span></span><br><span class="line">     builder: (BuildContext context, AsyncSnapshot&lt;<span class="built_in">int</span>&gt; snapshot) &#123;</span><br><span class="line">       <span class="keyword">if</span> (snapshot.hasError)</span><br><span class="line">         <span class="keyword">return</span> Text(<span class="string">'Error: <span class="subst">$&#123;snapshot.error&#125;</span>'</span>);</span><br><span class="line">       <span class="keyword">switch</span> (snapshot.connectionState) &#123;</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.none:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">'没有Stream'</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.waiting:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">'等待数据...'</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.active:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">'active: <span class="subst">$&#123;snapshot.data&#125;</span>'</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.done:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">'Stream已关闭'</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// unreachable</span></span><br><span class="line">     &#125;,</span><br><span class="line">   );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对话框">对话框</h3>
<h4 id="alertdialog">AlertDialog</h4>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AlertDialog(&#123;</span><br><span class="line">  Key key,</span><br><span class="line">  <span class="keyword">this</span>.title, <span class="comment">//对话框标题组件</span></span><br><span class="line">  <span class="keyword">this</span>.titlePadding, <span class="comment">// 标题填充</span></span><br><span class="line">  <span class="keyword">this</span>.titleTextStyle, <span class="comment">//标题文本样式</span></span><br><span class="line">  <span class="keyword">this</span>.content, <span class="comment">// 对话框内容组件</span></span><br><span class="line">  <span class="keyword">this</span>.contentPadding = <span class="keyword">const</span> EdgeInsets.fromLTRB(<span class="number">24.0</span>, <span class="number">20.0</span>, <span class="number">24.0</span>, <span class="number">24.0</span>), <span class="comment">//内容的填充</span></span><br><span class="line">  <span class="keyword">this</span>.contentTextStyle,<span class="comment">// 内容文本样式</span></span><br><span class="line">  <span class="keyword">this</span>.actions, <span class="comment">// 对话框操作按钮组</span></span><br><span class="line">  <span class="keyword">this</span>.backgroundColor, <span class="comment">// 对话框背景色</span></span><br><span class="line">  <span class="keyword">this</span>.elevation,<span class="comment">// 对话框的阴影</span></span><br><span class="line">  <span class="keyword">this</span>.semanticLabel, <span class="comment">//对话框语义化标签(用于读屏软件)</span></span><br><span class="line">  <span class="keyword">this</span>.shape, <span class="comment">// 对话框外形</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<p>对话框样式：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">AlertDialog(</span><br><span class="line">  title: Text(<span class="string">"提示"</span>),</span><br><span class="line">  content: Text(<span class="string">"您确定要删除当前文件吗?"</span>),</span><br><span class="line">  actions: &lt;Widget&gt;[</span><br><span class="line">    FlatButton(</span><br><span class="line">      child: Text(<span class="string">"取消"</span>),</span><br><span class="line">      onPressed: () =&gt; Navigator.of(context).pop(), <span class="comment">//关闭对话框</span></span><br><span class="line">    ),</span><br><span class="line">    FlatButton(</span><br><span class="line">      child: Text(<span class="string">"删除"</span>),</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        <span class="comment">// ... 执行删除操作</span></span><br><span class="line">        Navigator.of(context).pop(<span class="keyword">true</span>); <span class="comment">//关闭对话框</span></span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>通过<code>Navigator.of(context).pop(…)</code>方法来关闭对话框的，这和路由返回的方式是一致的，并且都可以返回一个结果数据。</p>
<p><code>showDialog()</code>是Material组件库提供的一个用于弹出Material风格对话框的方法</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T&gt; showDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="meta">@required</span> BuildContext context,</span><br><span class="line">  <span class="built_in">bool</span> barrierDismissible = <span class="keyword">true</span>, <span class="comment">//点击对话框barrier(遮罩)时是否关闭它</span></span><br><span class="line">  WidgetBuilder builder, <span class="comment">// 对话框UI的builder</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//点击该按钮后弹出对话框</span></span><br><span class="line">RaisedButton(</span><br><span class="line">  child: Text(<span class="string">"对话框1"</span>),</span><br><span class="line">  onPressed: () <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">//弹出对话框并等待其关闭</span></span><br><span class="line">    <span class="built_in">bool</span> delete = <span class="keyword">await</span> showDeleteConfirmDialog1();</span><br><span class="line">    <span class="keyword">if</span> (delete == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"取消删除"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"已确认删除"</span>);</span><br><span class="line">      <span class="comment">//... 删除文件</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">),</span><br><span class="line"></span><br><span class="line"><span class="comment">// 弹出对话框</span></span><br><span class="line">Future&lt;<span class="built_in">bool</span>&gt; showDeleteConfirmDialog1() &#123;</span><br><span class="line">  <span class="keyword">return</span> showDialog&lt;<span class="built_in">bool</span>&gt;(</span><br><span class="line">    context: context,</span><br><span class="line">    builder: (context) &#123;</span><br><span class="line">      <span class="keyword">return</span> AlertDialog(</span><br><span class="line">        title: Text(<span class="string">"提示"</span>),</span><br><span class="line">        content: Text(<span class="string">"您确定要删除当前文件吗?"</span>),</span><br><span class="line">        actions: &lt;Widget&gt;[</span><br><span class="line">          FlatButton(</span><br><span class="line">            child: Text(<span class="string">"取消"</span>),</span><br><span class="line">            onPressed: () =&gt; Navigator.of(context).pop(), <span class="comment">// 关闭对话框</span></span><br><span class="line">          ),</span><br><span class="line">          FlatButton(</span><br><span class="line">            child: Text(<span class="string">"删除"</span>),</span><br><span class="line">            onPressed: () &#123;</span><br><span class="line">              <span class="comment">//关闭对话框并返回true</span></span><br><span class="line">              Navigator.of(context).pop(<span class="keyword">true</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="simpledialog">SimpleDialog</h4>
<p><code>SimpleDialog</code>也是Material组件库提供的对话框，它会展示一个列表，用于列表选择的场景。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; changeLanguage() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> i = <span class="keyword">await</span> showDialog&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> SimpleDialog(</span><br><span class="line">          title: <span class="keyword">const</span> Text(<span class="string">'请选择语言'</span>),</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            SimpleDialogOption(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                <span class="comment">// 返回1</span></span><br><span class="line">                Navigator.pop(context, <span class="number">1</span>);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Padding(</span><br><span class="line">                padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">6</span>),</span><br><span class="line">                child: <span class="keyword">const</span> Text(<span class="string">'中文简体'</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            SimpleDialogOption(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                <span class="comment">// 返回2</span></span><br><span class="line">                Navigator.pop(context, <span class="number">2</span>);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Padding(</span><br><span class="line">                padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">6</span>),</span><br><span class="line">                child: <span class="keyword">const</span> Text(<span class="string">'美国英语'</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (i != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"选择了：<span class="subst">$&#123;i == <span class="number">1</span> ? <span class="string">"中文简体"</span> : <span class="string">"美国英语"</span>&#125;</span>"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="dialog">Dialog</h4>
<p><code>AlertDialog</code>和<code>SimpleDialog</code>都使用了<code>Dialog</code>类。由于<code>AlertDialog</code>和<code>SimpleDialog</code>中使用了<code>IntrinsicWidth</code>来尝试通过子组件的实际尺寸来调整自身尺寸，这就导致他们的子组件不能是延迟加载模型的组件（如<code>ListView</code>、<code>GridView</code> 、 <code>CustomScrollView</code>等。</p>
<p>如果需要嵌套一个<code>ListView，则可以直接使用</code>Dialog`类。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; showListDialog() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">int</span> index = <span class="keyword">await</span> showDialog&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">    context: context,</span><br><span class="line">    builder: (BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">var</span> child = Column(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          ListTile(title: Text(<span class="string">"请选择"</span>)),</span><br><span class="line">          Expanded(</span><br><span class="line">              child: ListView.builder(</span><br><span class="line">            itemCount: <span class="number">30</span>,</span><br><span class="line">            itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">              <span class="keyword">return</span> ListTile(</span><br><span class="line">                title: Text(<span class="string">"$index"</span>),</span><br><span class="line">                onTap: () =&gt; Navigator.of(context).pop(index),</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">          )),</span><br><span class="line">        ],</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">//使用AlertDialog会报错</span></span><br><span class="line">      <span class="comment">//return AlertDialog(content: child);</span></span><br><span class="line">      <span class="keyword">return</span> Dialog(child: child);</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"点击了：$index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>弹窗只是一个普通的widget，可以自己定义view，相当于就是自定义的弹框。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> UnconstrainedBox(</span><br><span class="line">  constrainedAxis: Axis.vertical,</span><br><span class="line">  child: ConstrainedBox(</span><br><span class="line">    constraints: BoxConstraints(maxWidth: <span class="number">280</span>),</span><br><span class="line">    child: Material(</span><br><span class="line">      child: child,</span><br><span class="line">      type: MaterialType.card,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="对话框动画及遮罩">对话框动画及遮罩</h4>
<p><code>showDialog</code>方法，它是Material组件库中提供的一个打开Material风格对话框的方法。那如何打开一个普通风格的对话框呢（非Material风格）？ Flutter 提供了一个<code>showGeneralDialog</code>方法，<code>showDialog</code>方法正是<code>showGeneralDialog</code>的一个封装。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T&gt; showGeneralDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="meta">@required</span> BuildContext context,</span><br><span class="line">  <span class="meta">@required</span> RoutePageBuilder pageBuilder, <span class="comment">//构建对话框内部UI</span></span><br><span class="line">  <span class="built_in">bool</span> barrierDismissible, <span class="comment">//点击遮罩是否关闭对话框</span></span><br><span class="line">  <span class="built_in">String</span> barrierLabel, <span class="comment">// 语义化标签(用于读屏软件)</span></span><br><span class="line">  Color barrierColor, <span class="comment">// 遮罩颜色</span></span><br><span class="line">  <span class="built_in">Duration</span> transitionDuration, <span class="comment">// 对话框打开/关闭的动画时长</span></span><br><span class="line">  RouteTransitionsBuilder transitionBuilder, <span class="comment">// 对话框打开/关闭的动画</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>举例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;T&gt; showCustomDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="meta">@required</span> BuildContext context,</span><br><span class="line">  <span class="built_in">bool</span> barrierDismissible = <span class="keyword">true</span>,</span><br><span class="line">  WidgetBuilder builder,</span><br><span class="line">&#125;) &#123;</span><br><span class="line">  <span class="keyword">final</span> ThemeData theme = Theme.of(context, shadowThemeOnly: <span class="keyword">true</span>);</span><br><span class="line">  <span class="keyword">return</span> showGeneralDialog(</span><br><span class="line">    context: context,</span><br><span class="line">    pageBuilder: (BuildContext buildContext, Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">        Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation) &#123;</span><br><span class="line">      <span class="keyword">final</span> Widget pageChild = Builder(builder: builder);</span><br><span class="line">      <span class="keyword">return</span> SafeArea(</span><br><span class="line">        child: Builder(builder: (BuildContext context) &#123;</span><br><span class="line">          <span class="keyword">return</span> theme != <span class="keyword">null</span></span><br><span class="line">              ? Theme(data: theme, child: pageChild)</span><br><span class="line">              : pageChild;</span><br><span class="line">        &#125;),</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">    barrierDismissible: barrierDismissible,</span><br><span class="line">    barrierLabel: MaterialLocalizations.of(context).modalBarrierDismissLabel,</span><br><span class="line">    barrierColor: Colors.black87, <span class="comment">// 自定义遮罩颜色</span></span><br><span class="line">    transitionDuration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">150</span>),</span><br><span class="line">    transitionBuilder: _buildMaterialDialogTransitions,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Widget _buildMaterialDialogTransitions(</span><br><span class="line">    BuildContext context,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation,</span><br><span class="line">    Widget child) &#123;</span><br><span class="line">  <span class="comment">// 使用缩放动画</span></span><br><span class="line">  <span class="keyword">return</span> ScaleTransition(</span><br><span class="line">    scale: CurvedAnimation(</span><br><span class="line">      parent: animation,</span><br><span class="line">      curve: Curves.easeOut,</span><br><span class="line">    ),</span><br><span class="line">    child: child,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，我们使用<code>showCustomDialog</code>打开文件删除确认对话框</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">showCustomDialog&lt;<span class="built_in">bool</span>&gt;(</span><br><span class="line">  context: context,</span><br><span class="line">  builder: (context) &#123;</span><br><span class="line">    <span class="keyword">return</span> AlertDialog(</span><br><span class="line">      title: Text(<span class="string">"提示"</span>),</span><br><span class="line">      content: Text(<span class="string">"您确定要删除当前文件吗?"</span>),</span><br><span class="line">      actions: &lt;Widget&gt;[</span><br><span class="line">        FlatButton(</span><br><span class="line">          child: Text(<span class="string">"取消"</span>),</span><br><span class="line">          onPressed: () =&gt; Navigator.of(context).pop(),</span><br><span class="line">        ),</span><br><span class="line">        FlatButton(</span><br><span class="line">          child: Text(<span class="string">"删除"</span>),</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            <span class="comment">// 执行删除操作</span></span><br><span class="line">            Navigator.of(context).pop(<span class="keyword">true</span>);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h4 id="对话框实现原理">对话框实现原理</h4>
<p>接调用<code>Navigator</code>的<code>push</code>方法打开了一个新的对话框路由<code>_DialogRoute</code>，然后返回了<code>push</code>的返回值。可见对话框实际上正是通过路由的形式实现的，这也是为什么我们可以使用<code>Navigator</code>的<code>pop</code> 方法来退出对话框的原因。</p>
<h4 id="对话框状态管理">对话框状态管理</h4>
<p>我们知道在操作对话框里的组件来<code>setState</code>方法只会针对当前context的子树重新build，但是我们的对话框并不是在<code>_DialogRouteState</code>的<code>build</code> 方法中构建的，而是通过<code>showDialog</code>单独构建的，所以在<code>_DialogRouteState</code>的context中调用<code>setState</code>是无法影响通过<code>showDialog</code>构建的UI的，。另外，我们可以从另外一个角度来理解这个现象，前面说过对话框也是通过路由的方式来实现的，那么上面的代码实际上就等同于企图在父路由中调用<code>setState</code>来让子路由更新，这显然是不行的！<strong>也就是说其实对话框是另一个页面，setState影响不到UI页面</strong>。简尔言之，根本原因就是context不对。</p>
<p>方案一：单独抽离出StatefulWidget</p>
<p>单独抽离对话框到新的StatefulWidget，但是同时使用回调将值返回给Ui。</p>
<p>方案二：使用StatefulBuilder方法</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StatefulBuilder</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> StatefulBuilder(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">  &#125;) : <span class="keyword">assert</span>(builder != <span class="keyword">null</span>),</span><br><span class="line">       <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> StatefulWidgetBuilder builder;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _StatefulBuilderState createState() =&gt; _StatefulBuilderState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StatefulBuilderState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StatefulBuilder</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) =&gt; widget.builder(context, setState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Row(</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Text(<span class="string">"同时删除子目录？"</span>),</span><br><span class="line">    <span class="comment">//使用StatefulBuilder来构建StatefulWidget上下文</span></span><br><span class="line">    StatefulBuilder(</span><br><span class="line">      builder: (context, _setState) &#123;</span><br><span class="line">        <span class="keyword">return</span> Checkbox(</span><br><span class="line">          value: _withTree, <span class="comment">//默认不选中</span></span><br><span class="line">          onChanged: (<span class="built_in">bool</span> value) &#123;</span><br><span class="line">            <span class="comment">//_setState方法实际就是该StatefulWidget的setState方法，</span></span><br><span class="line">            <span class="comment">//调用后builder方法会重新被调用</span></span><br><span class="line">            _setState(() &#123;</span><br><span class="line">              <span class="comment">//更新选中状态</span></span><br><span class="line">              _withTree = !_withTree;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<p>方案三：使用markNeedsBuild</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">... <span class="comment">//省略无关代码</span></span><br><span class="line">Row(</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Text(<span class="string">"同时删除子目录？"</span>),</span><br><span class="line">    <span class="comment">// 通过Builder来获得构建Checkbox的`context`，</span></span><br><span class="line">    <span class="comment">// 这是一种常用的缩小`context`范围的方式</span></span><br><span class="line">    Builder(</span><br><span class="line">      builder: (BuildContext context) &#123;</span><br><span class="line">        <span class="keyword">return</span> Checkbox(</span><br><span class="line">          value: _withTree,</span><br><span class="line">          onChanged: (<span class="built_in">bool</span> value) &#123;</span><br><span class="line">            (context <span class="keyword">as</span> <span class="built_in">Element</span>).markNeedsBuild();</span><br><span class="line">            _withTree = !_withTree;</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<h4 id="其它类型的对话框">其它类型的对话框</h4>
<h5 id="底部菜单列表">底部菜单列表</h5>
<p><code>howModalBottomSheet</code>方法可以弹出一个Material风格的底部菜单列表模态对话框，示例如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 弹出底部菜单列表模态对话框</span></span><br><span class="line">Future&lt;<span class="built_in">int</span>&gt; _showModalBottomSheet() &#123;</span><br><span class="line">  <span class="keyword">return</span> showModalBottomSheet&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">    context: context,</span><br><span class="line">    builder: (BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> ListView.builder(</span><br><span class="line">        itemCount: <span class="number">30</span>,</span><br><span class="line">        itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">          <span class="keyword">return</span> ListTile(</span><br><span class="line">            title: Text(<span class="string">"$index"</span>),</span><br><span class="line">            onTap: () =&gt; Navigator.of(context).pop(index),</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还有一个<code>showBottomSheet</code>方法，该方法会从设备底部向上弹出一个全屏的菜单列表，示例如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回的是一个controller</span></span><br><span class="line">PersistentBottomSheetController&lt;<span class="built_in">int</span>&gt; _showBottomSheet() &#123;</span><br><span class="line">  <span class="keyword">return</span> showBottomSheet&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">    context: context,</span><br><span class="line">    builder: (BuildContext context) &#123;</span><br><span class="line">      <span class="keyword">return</span> ListView.builder(</span><br><span class="line">        itemCount: <span class="number">30</span>,</span><br><span class="line">        itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">          <span class="keyword">return</span> ListTile(</span><br><span class="line">            title: Text(<span class="string">"$index"</span>),</span><br><span class="line">            onTap: ()&#123;</span><br><span class="line">              <span class="comment">// do something</span></span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"$index"</span>);</span><br><span class="line">              Navigator.of(context).pop();</span><br><span class="line">            &#125;,</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="loading框">Loading框</h5>
<p>Loading框可以直接通过<code>showDialog</code>+<code>AlertDialog</code>来自定义</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">showLoadingDialog() &#123;</span><br><span class="line">  showDialog(</span><br><span class="line">    context: context,</span><br><span class="line">    barrierDismissible: <span class="keyword">false</span>, <span class="comment">//点击遮罩不关闭对话框</span></span><br><span class="line">    builder: (context) &#123;</span><br><span class="line">      <span class="keyword">return</span> AlertDialog(</span><br><span class="line">        content: Column(</span><br><span class="line">          mainAxisSize: MainAxisSize.min,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            CircularProgressIndicator(),</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.only(top: <span class="number">26.0</span>),</span><br><span class="line">              child: Text(<span class="string">"正在加载，请稍后..."</span>),</span><br><span class="line">            )</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="日历选择">日历选择</h5>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">DateTime</span>&gt; _showDatePicker1() &#123;</span><br><span class="line">  <span class="keyword">var</span> date = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="keyword">return</span> showDatePicker(</span><br><span class="line">    context: context,</span><br><span class="line">    initialDate: date,</span><br><span class="line">    firstDate: date,</span><br><span class="line">    lastDate: date.add( <span class="comment">//未来30天可选</span></span><br><span class="line">      <span class="built_in">Duration</span>(days: <span class="number">30</span>),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>iOS风格的日历选择器需要使用<code>showCupertinoModalPopup</code>方法和<code>CupertinoDatePicker</code>组件来实现：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">DateTime</span>&gt; _showDatePicker2() &#123;</span><br><span class="line">  <span class="keyword">var</span> date = <span class="built_in">DateTime</span>.now();</span><br><span class="line">  <span class="keyword">return</span> showCupertinoModalPopup(</span><br><span class="line">    context: context,</span><br><span class="line">    builder: (ctx) &#123;</span><br><span class="line">      <span class="keyword">return</span> SizedBox(</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        child: CupertinoDatePicker(</span><br><span class="line">          mode: CupertinoDatePickerMode.dateAndTime,</span><br><span class="line">          minimumDate: date,</span><br><span class="line">          maximumDate: date.add(</span><br><span class="line">            <span class="built_in">Duration</span>(days: <span class="number">30</span>),</span><br><span class="line">          ),</span><br><span class="line">          maximumYear: date.year + <span class="number">1</span>,</span><br><span class="line">          onDateTimeChanged: (<span class="built_in">DateTime</span> value) &#123;</span><br><span class="line">            <span class="built_in">print</span>(value);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="动画">动画</h2>
<p>Flutter中也对动画进行了抽象，主要涉及Animation、Curve、Controller、Tween这四个角色，它们一起配合来完成一个完整动画。</p>
<h4 id="animation">Animation</h4>
<p><code>Animation</code>是一个抽象类，它本身和UI渲染没有任何关系，而它主要的功能是保存动画的插值和状态；其中一个比较常用的<code>Animation</code>类是<code>Animation&lt;double&gt;</code>。</p>
<p><code>Animation</code>对象是一个在一段时间内依次生成一个区间(Tween)之间值的类。<code>Animation</code>对象在整个动画执行过程中输出的值可以是线性的、曲线的、一个步进函数或者任何其他曲线函数等等，这由<code>Curve</code>来决定</p>
<p>根据<code>Animation</code>对象的控制方式，动画可以正向运行（从起始状态开始，到终止状态结束），也可以反向运行，甚至可以在中间切换方向。<code>Animation</code>还可以生成除<code>double</code>之外的其他类型值，如：<code>Animation&lt;Color&gt;</code> 或<code>Animation&lt;Size&gt;</code>。在动画的每一帧中，我们可以通过<code>Animation</code>对象的<code>value</code>属性获取动画的当前状态值。</p>
<h4 id="动画通知">动画通知</h4>
<p>我们可以通过<code>Animation</code>来监听动画每一帧以及执行状态的变化，<code>Animation</code>有如下两个方法：</p>
<ol>
<li><code>addListener()</code>；它可以用于给<code>Animation</code>添加帧监听器，在每一帧都会被调用。帧监听器中最常见的行为是改变状态后调用<code>setState()</code>来触发UI重建。</li>
<li><code>addStatusListener()</code>；它可以给<code>Animation</code>添加“动画状态改变”监听器；动画开始、结束、正向或反向（见<code>AnimationStatus</code>定义）时会调用状态改变的监听器。</li>
</ol>
<h4 id="curve">Curve</h4>
<p>动画过程可以是匀速的、匀加速的或者先加速后减速等。Flutter中通过<code>Curve</code>（曲线）来描述动画过程，我们把匀速动画称为线性的(Curves.linear)，而非匀速动画称为非线性的。</p>
<p>我们可以通过<code>CurvedAnimation</code>来指定动画的曲线，如：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> CurvedAnimation curve =</span><br><span class="line">    <span class="keyword">new</span> CurvedAnimation(parent: controller, curve: Curves.easeIn);</span><br></pre></td></tr></table></figure>
<p><code>urvedAnimation</code>和<code>AnimationController</code>（下面介绍）都是<code>Animation&lt;double&gt;</code>类型。<code>CurvedAnimation</code>可以通过包装<code>AnimationController</code>和<code>Curve</code>生成一个新的动画对象 ，我们正是通过这种方式来将动画和动画执行的曲线关联起来的。我们指定动画的曲线为<code>Curves.easeIn</code>，它表示动画开始时比较慢，结束时比较快。 <a href="https://docs.flutter.io/flutter/animation/Curves-class.html" target="_blank" rel="noopener">Curves</a> 类是一个预置的枚举类，定义了许多常用的曲线，下面列几种常用的：</p>
<table>
<thead>
<tr>
<th>Curves曲线</th>
<th>动画过程</th>
</tr>
</thead>
<tbody>
<tr>
<td>linear</td>
<td>匀速的</td>
</tr>
<tr>
<td>decelerate</td>
<td>匀减速</td>
</tr>
<tr>
<td>ease</td>
<td>开始加速，后面减速</td>
</tr>
<tr>
<td>easeIn</td>
<td>开始慢，后面快</td>
</tr>
<tr>
<td>easeOut</td>
<td>开始快，后面慢</td>
</tr>
<tr>
<td>easeInOut</td>
<td>开始慢，然后加速，最后再减速</td>
</tr>
</tbody>
</table>
<p>自定义Curve：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShakeCurve</span> <span class="keyword">extends</span> <span class="title">Curve</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">double</span> transform(<span class="built_in">double</span> t) &#123;</span><br><span class="line">    <span class="keyword">return</span> math.sin(t * math.PI * <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="animationcontroller">AnimationController</h4>
<p><code>AnimationController</code>用于控制动画，它包含动画的启动<code>forward()</code>、停止<code>stop()</code> 、反向播放 <code>reverse()</code>等方法。<code>AnimationController</code>会在动画的每一帧，就会生成一个新的值。默认情况下，<code>AnimationController</code>在给定的时间段内线性的生成从0.0到1.0（默认区间）的数字。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inal AnimationController controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">    duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">2000</span>), vsync: <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p><code>AnimationController</code>生成数字的区间可以通过<code>lowerBound</code>和<code>upperBound</code>来指定，如：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AnimationController controller = <span class="keyword">new</span> AnimationController( </span><br><span class="line"> duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">2000</span>), </span><br><span class="line"> lowerBound: <span class="number">10.0</span>,</span><br><span class="line"> upperBound: <span class="number">20.0</span>,</span><br><span class="line"> vsync: <span class="keyword">this</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>AnimationController</code>派生自<code>Animation&lt;double&gt;</code>，因此可以在需要<code>Animation</code>对象的任何地方使用。 但是，<code>AnimationController</code>具有控制动画的其他方法，例如<code>forward()</code>方法可以启动正向动画，<code>reverse()</code>可以启动反向动画。在动画开始执行后开始生成动画帧，屏幕每刷新一次就是一个动画帧，在动画的每一帧，会随着根据动画的曲线来生成当前的动画值（<code>Animation.value</code>），然后根据当前的动画值去构建UI，当所有动画帧依次触发时，动画值会依次改变，所以构建的UI也会依次变化，所以最终我们可以看到一个完成的动画。 另外在动画的每一帧，<code>Animation</code>对象会调用其帧监听器，等动画状态发生改变时（如动画结束）会调用状态改变监听器。</p>
<h4 id="ticker">Ticker</h4>
<p>当创建一个<code>AnimationController</code>时，需要传递一个<code>vsync</code>参数，它接收一个<code>TickerProvider</code>类型的对象，它的主要职责是创建<code>Ticker</code>，定义如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TickerProvider</span> </span>&#123;</span><br><span class="line">  <span class="comment">//通过一个回调创建一个Ticker</span></span><br><span class="line">  Ticker createTicker(TickerCallback onTick);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Flutter应用在启动时都会绑定一个<code>SchedulerBinding</code>，通过<code>SchedulerBinding</code>可以给每一次屏幕刷新添加回调，而<code>Ticker</code>就是通过<code>SchedulerBinding</code>来添加屏幕刷新回调，这样一来，每次屏幕刷新都会调用<code>TickerCallback</code>。使用<code>Ticker</code>(而不是<code>Timer</code>)来驱动动画会防止屏幕外动画（动画的UI不在当前屏幕时，如锁屏时）消耗不必要的资源，因为Flutter中屏幕刷新时会通知到绑定的<code>SchedulerBinding</code>，而<code>Ticker</code>是受<code>SchedulerBinding</code>驱动的，由于锁屏后屏幕会停止刷新，所以<code>Ticker</code>就不会再触发。</p>
<h4 id="tween">Tween</h4>
<p>默认情况下，<code>AnimationController</code>对象值的范围是[0.0，1.0]。如果我们需要构建UI的动画值在不同的范围或不同的数据类型，则可以使用<code>Tween</code>来添加映射以生成不同的范围或数据类型的值。例如，像下面示例，<code>Tween</code>生成[-200.0，0.0]的值：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Tween doubleTween = <span class="keyword">new</span> Tween&lt;<span class="built_in">double</span>&gt;(begin: <span class="number">-200.0</span>, end: <span class="number">0.0</span>);</span><br></pre></td></tr></table></figure>
<p><code>Tween</code>构造函数需要<code>begin</code>和<code>end</code>两个参数。<code>Tween</code>的唯一职责就是定义从输入范围到输出范围的映射。输入范围通常为[0.0，1.0]，但这不是必须的，我们可以自定义需要的范围。</p>
<p><code>Tween</code>继承自<code>Animatable&lt;T&gt;</code>，而不是继承自<code>Animation&lt;T&gt;</code>，<code>Animatable</code>中主要定义动画值的映射规则。</p>
<p>下面我们看一个ColorTween将动画输入范围映射为两种颜色值之间过渡输出的例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Tween colorTween =</span><br><span class="line">    <span class="keyword">new</span> ColorTween(begin: Colors.transparent, end: Colors.black54);</span><br></pre></td></tr></table></figure>
<p><code>Tween</code>对象不存储任何状态，相反，它提供了<code>evaluate(Animation&lt;double&gt; animation)</code>方法，它可以获取动画当前映射值。 <code>Animation</code>对象的当前值可以通过<code>value()</code>方法取到。<code>evaluate</code>函数还执行一些其它处理，例如分别确保在动画值为0.0和1.0时返回开始和结束状态。</p>
<h4 id="tweenanimate">Tween.animate</h4>
<p>要使用Tween对象，需要调用其<code>animate()</code>方法，然后传入一个控制器对象。例如，以下代码在500毫秒内生成从0到255的整数值。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AnimationController controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">    duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">500</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">Animation&lt;<span class="built_in">int</span>&gt; alpha = <span class="keyword">new</span> IntTween(begin: <span class="number">0</span>, end: <span class="number">255</span>).animate(controller);</span><br></pre></td></tr></table></figure>
<p>注意<code>animate()</code>返回的是一个<code>Animation</code>，而不是一个<code>Animatable</code>。</p>
<p>以下示例构建了一个控制器、一条曲线和一个Tween：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AnimationController controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">    duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">500</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line"><span class="keyword">final</span> Animation curve =</span><br><span class="line">    <span class="keyword">new</span> CurvedAnimation(parent: controller, curve: Curves.easeOut);</span><br><span class="line">Animation&lt;<span class="built_in">int</span>&gt; alpha = <span class="keyword">new</span> IntTween(begin: <span class="number">0</span>, end: <span class="number">255</span>).animate(curve);</span><br></pre></td></tr></table></figure>
<p>使用例子：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaleAnimationRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ScaleAnimationRouteState createState() =&gt; <span class="keyword">new</span> _ScaleAnimationRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//需要继承TickerProvider，如果有多个AnimationController，则应该使用TickerProviderStateMixin。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ScaleAnimationRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ScaleAnimationRoute</span>&gt;  <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span></span>&#123; </span><br><span class="line"></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; animation;</span><br><span class="line">  AnimationController controller;</span><br><span class="line"></span><br><span class="line">  initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">        duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">3</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//图片宽高从0变到300</span></span><br><span class="line">    animation = <span class="keyword">new</span> Tween(begin: <span class="number">0.0</span>, end: <span class="number">300.0</span>).animate(controller)</span><br><span class="line">      ..addListener(() &#123;</span><br><span class="line">        setState(()=&gt;&#123;&#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">//启动动画(正向执行)</span></span><br><span class="line">    controller.forward();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Center(</span><br><span class="line">       child: Image.asset(<span class="string">"imgs/avatar.png"</span>,</span><br><span class="line">          width: animation.value,</span><br><span class="line">          height: animation.value</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dispose() &#123;</span><br><span class="line">    <span class="comment">//路由销毁时需要释放动画资源</span></span><br><span class="line">    controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中<code>addListener()</code>函数调用了<code>setState()</code>，所以每次动画生成一个新的数字时，当前帧被标记为脏(dirty)，这会导致widget的<code>build()</code>方法再次被调用，而在<code>build()</code>中，改变Image的宽高，因为它的高度和宽度现在使用的是<code>animation.value</code> ，所以就会逐渐放大。</p>
<p>指定Curve：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">        duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">3</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//使用弹性曲线</span></span><br><span class="line">    animation=CurvedAnimation(parent: controller, curve: Curves.bounceIn);</span><br><span class="line">    <span class="comment">//图片宽高从0变到300</span></span><br><span class="line">    animation = <span class="keyword">new</span> Tween(begin: <span class="number">0.0</span>, end: <span class="number">300.0</span>).animate(animation)</span><br><span class="line">      ..addListener(() &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="comment">//启动动画</span></span><br><span class="line">    controller.forward();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="使用animatedwidget简化">使用AnimatedWidget简化</h4>
<p>细心的读者可能已经发现上面示例中通过<code>addListener()</code>和<code>setState()</code> 来更新UI这一步其实是通用的，如果每个动画中都加这么一句是比较繁琐的。<code>AnimatedWidget</code>类封装了调用<code>setState()</code>的细节，并允许我们将widget分离出来。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedImage</span> <span class="keyword">extends</span> <span class="title">AnimatedWidget</span> </span>&#123;</span><br><span class="line">  AnimatedImage(&#123;Key key, Animation&lt;<span class="built_in">double</span>&gt; animation&#125;)</span><br><span class="line">      : <span class="keyword">super</span>(key: key, listenable: animation);</span><br><span class="line"></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> Animation&lt;<span class="built_in">double</span>&gt; animation = listenable;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Center(</span><br><span class="line">      child: Image.asset(<span class="string">"imgs/avatar.png"</span>,</span><br><span class="line">          width: animation.value,</span><br><span class="line">          height: animation.value</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaleAnimationRoute1</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ScaleAnimationRouteState createState() =&gt; <span class="keyword">new</span> _ScaleAnimationRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ScaleAnimationRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ScaleAnimationRoute1</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; animation;</span><br><span class="line">  AnimationController controller;</span><br><span class="line"></span><br><span class="line">  initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">        duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">3</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//图片宽高从0变到300</span></span><br><span class="line">    animation = <span class="keyword">new</span> Tween(begin: <span class="number">0.0</span>, end: <span class="number">300.0</span>).animate(controller);</span><br><span class="line">    <span class="comment">//启动动画</span></span><br><span class="line">    controller.forward();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> AnimatedImage(animation: animation,);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dispose() &#123;</span><br><span class="line">    <span class="comment">//路由销毁时需要释放动画资源</span></span><br><span class="line">    controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="用animatedbuilder重构">用AnimatedBuilder重构</h4>
<p>用AnimatedWidget可以从动画中分离出widget，而动画的渲染过程（即设置宽高）仍然在AnimatedWidget中，假设如果我们再添加一个widget透明度变化的动画，那么我们需要再实现一个AnimatedWidget，这样不是很优雅，如果我们能把渲染过程也抽象出来，那就会好很多，而AnimatedBuilder正是将渲染逻辑分离出来。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="comment">//return AnimatedImage(animation: animation,);</span></span><br><span class="line">    <span class="keyword">return</span> AnimatedBuilder(</span><br><span class="line">      animation: animation,</span><br><span class="line">      child: Image.asset(<span class="string">"images/avatar.png"</span>),</span><br><span class="line">      builder: (BuildContext ctx, Widget child) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Center(</span><br><span class="line">          child: Container(</span><br><span class="line">              height: animation.value, </span><br><span class="line">              width: animation.value, </span><br><span class="line">              child: child,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中有一个迷惑的问题是，<code>child</code>看起来像被指定了两次。但实际发生的事情是：将外部引用<code>child</code>传递给<code>AnimatedBuilder</code>后<code>AnimatedBuilder</code>再将其传递给匿名构造器， 然后将该对象用作其子对象。最终的结果是<code>AnimatedBuilder</code>返回的对象插入到widget树中。</p>
<p>也许你会说这和我们刚开始的示例差不了多少，其实它会带来三个好处：</p>
<ol>
<li>不用显式的去添加帧监听器，然后再调用<code>setState()</code> 了，这个好处和<code>AnimatedWidget</code>是一样的。</li>
<li>动画构建的范围缩小了，如果没有<code>builder</code>，<code>setState()</code>将会在父组件上下文中调用，这将会导致父组件的<code>build</code>方法重新调用；而有了<code>builder</code>之后，只会导致动画widget自身的<code>build</code>重新调用，避免不必要的rebuild。</li>
<li>通过<code>AnimatedBuilder</code>可以封装常见的过渡效果来复用动画。下面我们通过封装一个<code>GrowTransition</code>来说明，它可以对子widget实现放大动画</li>
</ol>
<p>也许你会说这和我们刚开始的示例差不了多少，其实它会带来三个好处：</p>
<ol>
<li>
<p>不用显式的去添加帧监听器，然后再调用<code>setState()</code> 了，这个好处和<code>AnimatedWidget</code>是一样的。</p>
</li>
<li>
<p>动画构建的范围缩小了，如果没有<code>builder</code>，<code>setState()</code>将会在父组件上下文中调用，这将会导致父组件的<code>build</code>方法重新调用；而有了<code>builder</code>之后，只会导致动画widget自身的<code>build</code>重新调用，避免不必要的rebuild。</p>
</li>
<li>
<p>通过<code>AnimatedBuilder</code>可以封装常见的过渡效果来复用动画。下面我们通过封装一个<code>GrowTransition</code>来说明，它可以对子widget实现放大动画：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GrowTransition</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  GrowTransition(&#123;<span class="keyword">this</span>.child, <span class="keyword">this</span>.animation&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line">  <span class="keyword">final</span> Animation&lt;<span class="built_in">double</span>&gt; animation;</span><br><span class="line"></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Center(</span><br><span class="line">      child: <span class="keyword">new</span> AnimatedBuilder(</span><br><span class="line">          animation: animation,</span><br><span class="line">          builder: (BuildContext context, Widget child) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Container(</span><br><span class="line">                height: animation.value, </span><br><span class="line">                width: animation.value, </span><br><span class="line">                child: child</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">          child: child</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，最初的示例就可以改为：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GrowTransition(</span><br><span class="line">    child: Image.asset(<span class="string">"images/avatar.png"</span>), </span><br><span class="line">    animation: animation,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Flutter中正是通过这种方式封装了很多动画，如：FadeTransition、ScaleTransition、SizeTransition等，很多时候都可以复用这些预置的过渡类。</strong></p>
</li>
</ol>
<h4 id="动画状态监听">动画状态监听</h4>
<p>可以通过<code>Animation</code>的<code>addStatusListener()</code>方法来添加动画状态改变监听器。Flutter中，有四种动画状态，在<code>AnimationStatus</code>枚举类中定义，下面我们逐个说明：</p>
<table>
<thead>
<tr>
<th>枚举值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dismissed</code></td>
<td>动画在起始点停止</td>
</tr>
<tr>
<td><code>forward</code></td>
<td>动画正在正向执行</td>
</tr>
<tr>
<td><code>reverse</code></td>
<td>动画正在反向执行</td>
</tr>
<tr>
<td><code>completed</code></td>
<td>动画在终点停止</td>
</tr>
</tbody>
</table>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">initState() &#123;</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line">  controller = <span class="keyword">new</span> AnimationController(</span><br><span class="line">      duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>), vsync: <span class="keyword">this</span>);</span><br><span class="line">  <span class="comment">//图片宽高从0变到300</span></span><br><span class="line">  animation = <span class="keyword">new</span> Tween(begin: <span class="number">0.0</span>, end: <span class="number">300.0</span>).animate(controller);</span><br><span class="line">  animation.addStatusListener((status) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status == AnimationStatus.completed) &#123;</span><br><span class="line">      <span class="comment">//动画执行结束时反向执行动画</span></span><br><span class="line">      controller.reverse();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == AnimationStatus.dismissed) &#123;</span><br><span class="line">      <span class="comment">//动画恢复到初始状态时执行动画（正向）</span></span><br><span class="line">      controller.forward();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//启动动画（正向）</span></span><br><span class="line">  controller.forward();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="路由切换动画">路由切换动画</h3>
<p>Material组件库中提供了一个<code>MaterialPageRoute</code>组件，它可以使用和平台风格一致的路由切换动画，如在iOS上会左右滑动切换，而在Android上会上下滑动切换。现在，我们如果在Android上也想使用左右切换风格，该怎么做？一个简单的作法是可以直接使用<code>CupertinoPageRoute</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(context, CupertinoPageRoute(  </span><br><span class="line">  builder: (context)=&gt;PageB(),</span><br><span class="line">));</span><br></pre></td></tr></table></figure>
<p>CupertinoPageRoute<code>是Cupertino组件库提供的iOS风格的路由切换组件，它实现的就是左右滑动切换。那么我们如何来自定义路由切换动画呢？答案就是</code>PageRouteBuilder。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(</span><br><span class="line">  context,</span><br><span class="line">  PageRouteBuilder(</span><br><span class="line">    transitionDuration: <span class="built_in">Duration</span>(milliseconds: <span class="number">500</span>), <span class="comment">//动画时间为500毫秒</span></span><br><span class="line">    pageBuilder: (BuildContext context, Animation animation,</span><br><span class="line">        Animation secondaryAnimation) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> FadeTransition(</span><br><span class="line">        <span class="comment">//使用渐隐渐入过渡,</span></span><br><span class="line">        opacity: animation,</span><br><span class="line">        child: PageB(), <span class="comment">//路由B</span></span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>，我们可以直接继承<code>PageRoute</code>类来实现自定义路由，上面的例子可以通过如下方式实现：</p>
<ol>
<li>
<p>定义一个路由类<code>FadeRoute</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FadeRoute</span> <span class="keyword">extends</span> <span class="title">PageRoute</span> </span>&#123;</span><br><span class="line">  FadeRoute(&#123;</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">    <span class="keyword">this</span>.transitionDuration = <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">300</span>),</span><br><span class="line">    <span class="keyword">this</span>.opaque = <span class="keyword">true</span>,</span><br><span class="line">    <span class="keyword">this</span>.barrierDismissible = <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">this</span>.barrierColor,</span><br><span class="line">    <span class="keyword">this</span>.barrierLabel,</span><br><span class="line">    <span class="keyword">this</span>.maintainState = <span class="keyword">true</span>,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> WidgetBuilder builder;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Duration</span> transitionDuration;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> opaque;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> barrierDismissible;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> Color barrierColor;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> barrierLabel;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> maintainState;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget buildPage(BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">      Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation) =&gt; builder(context);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget buildTransitions(BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">      Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation, Widget child) &#123;</span><br><span class="line">     <span class="keyword">return</span> FadeTransition( </span><br><span class="line">       opacity: animation,</span><br><span class="line">       child: builder(context),</span><br><span class="line">     );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用<code>FadeRoute</code></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Navigator.push(context, FadeRoute(builder: (context) &#123;</span><br><span class="line">  <span class="keyword">return</span> PageB();</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>虽然上面的两种方法都可以实现自定义切换动画，但实际使用时应优先考虑使用PageRouteBuilder，这样无需定义一个新的路由类，使用起来会比较方便。但是有些时候<code>PageRouteBuilder</code>是不能满足需求的，例如在应用过渡动画时我们需要读取当前路由的一些属性，这时就只能通过继承<code>PageRoute</code>的方式了，举个例子，假如我们只想在打开新路由时应用动画，而在返回时不使用动画，那么我们在构建过渡动画时就必须判断当前路由<code>isActive</code>属性是否为<code>true</code>，代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget buildTransitions(BuildContext context, Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">    Animation&lt;<span class="built_in">double</span>&gt; secondaryAnimation, Widget child) &#123;</span><br><span class="line"> <span class="comment">//当前路由被激活，是打开新路由</span></span><br><span class="line"> <span class="keyword">if</span>(isActive) &#123;</span><br><span class="line">   <span class="keyword">return</span> FadeTransition(</span><br><span class="line">     opacity: animation,</span><br><span class="line">     child: builder(context),</span><br><span class="line">   );</span><br><span class="line"> &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="comment">//是返回，则不应用过渡动画</span></span><br><span class="line">   <span class="keyword">return</span> Padding(padding: EdgeInsets.zero);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hero动画">Hero动画</h3>
<p>Hero指的是可以在路由(页面)之间“飞行”的widget，简单来说Hero动画就是在路由切换时，有一个共享的widget可以在新旧路由间切换。由于共享的widget在新旧路由页面上的位置、外观可能有所差异，所以在路由切换时会从旧路逐渐过渡到新路由中的指定位置，这样就会产生一个Hero动画。</p>
<h4 id="示例">示例</h4>
<p>假设有两个路由A和B，他们的内容交互如下：</p>
<p>A：包含一个用户头像，圆形，点击后跳到B路由，可以查看大图。</p>
<p>B：显示用户头像原图，矩形；</p>
<p>在AB两个路由之间跳转的时候，用户头像会逐渐过渡到目标路由页的头像上，接下来我们先看看代码，然后再解析：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路由A</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAnimationRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      alignment: Alignment.topCenter,</span><br><span class="line">      child: InkWell(</span><br><span class="line">        child: Hero(</span><br><span class="line">          tag: <span class="string">"avatar"</span>, <span class="comment">//唯一标记，前后两个路由页Hero的tag必须相同</span></span><br><span class="line">          child: ClipOval(</span><br><span class="line">            child: Image.asset(<span class="string">"images/avatar.png"</span>,</span><br><span class="line">              width: <span class="number">50.0</span>,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        onTap: () &#123;</span><br><span class="line">          <span class="comment">//打开B路由  </span></span><br><span class="line">          Navigator.push(context, PageRouteBuilder(</span><br><span class="line">              pageBuilder: (BuildContext context, Animation animation,</span><br><span class="line">                  Animation secondaryAnimation) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> FadeTransition(</span><br><span class="line">                  opacity: animation,</span><br><span class="line">                  child: Scaffold(</span><br><span class="line">                    appBar: AppBar(</span><br><span class="line">                      title: Text(<span class="string">"原图"</span>),</span><br><span class="line">                    ),</span><br><span class="line">                    body: HeroAnimationRouteB(),</span><br><span class="line">                  ),</span><br><span class="line">                );</span><br><span class="line">              &#125;)</span><br><span class="line">          );</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路由B:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeroAnimationRouteB</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: Hero(</span><br><span class="line">          tag: <span class="string">"avatar"</span>, <span class="comment">//唯一标记，前后两个路由页Hero的tag必须相同</span></span><br><span class="line">          child: Image.asset(<span class="string">"images/avatar.png"</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，实现Hero动画只需要用<code>Hero</code>组件将要共享的widget包装起来，并提供一个相同的tag即可，中间的过渡帧都是Flutter Framework自动完成的。必须要注意， 前后路由页的共享<code>Hero</code>的tag必须是相同的，Flutter Framework内部正是通过tag来确定新旧路由页widget的对应关系的。</p>
<h3 id="交织动画">交织动画</h3>
<p>有些时候我们可能会需要一些复杂的动画，这些动画可能由一个动画序列或重叠的动画组成，比如：有一个柱状图，需要在高度增长的同时改变颜色，等到增长到最大高度后，我们需要在X轴上平移一段距离。可以发现上述场景在不同阶段包含了多种动画，要实现这种效果，使用交织动画（Stagger Animation）会非常简单。交织动画需要注意以下几点：</p>
<ol>
<li>要创建交织动画，需要使用多个动画对象（<code>Animation</code>）。</li>
<li>一个<code>AnimationController</code>控制所有的动画对象。</li>
<li>给每一个动画对象指定时间间隔（Interval）</li>
</ol>
<h3 id="示例">示例</h3>
<p>下面我们看一个例子，实现一个柱状图增长的动画：</p>
<ol>
<li>开始时高度从0增长到300像素，同时颜色由绿色渐变为红色；这个过程占据整个动画时间的60%。</li>
<li>高度增长到300后，开始沿X轴向右平移100像素；这个过程占用整个动画时间的40%。</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaggerAnimation</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  StaggerAnimation(&#123; Key key, <span class="keyword">this</span>.controller &#125;): <span class="keyword">super</span>(key: key)&#123;</span><br><span class="line">    <span class="comment">//高度动画</span></span><br><span class="line">    height = Tween&lt;<span class="built_in">double</span>&gt;(</span><br><span class="line">      begin:<span class="number">.0</span> ,</span><br><span class="line">      end: <span class="number">300.0</span>,</span><br><span class="line">    ).animate(</span><br><span class="line">      CurvedAnimation(</span><br><span class="line">        parent: controller,</span><br><span class="line">        curve: Interval(</span><br><span class="line">          <span class="number">0.0</span>, <span class="number">0.6</span>, <span class="comment">//间隔，前60%的动画时间</span></span><br><span class="line">          curve: Curves.ease,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    color = ColorTween(</span><br><span class="line">      begin:Colors.green ,</span><br><span class="line">      end:Colors.red,</span><br><span class="line">    ).animate(</span><br><span class="line">      CurvedAnimation(</span><br><span class="line">        parent: controller,</span><br><span class="line">        curve: Interval(</span><br><span class="line">          <span class="number">0.0</span>, <span class="number">0.6</span>,<span class="comment">//间隔，前60%的动画时间</span></span><br><span class="line">          curve: Curves.ease,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    padding = Tween&lt;EdgeInsets&gt;(</span><br><span class="line">      begin:EdgeInsets.only(left: <span class="number">.0</span>),</span><br><span class="line">      end:EdgeInsets.only(left: <span class="number">100.0</span>),</span><br><span class="line">    ).animate(</span><br><span class="line">      CurvedAnimation(</span><br><span class="line">        parent: controller,</span><br><span class="line">        curve: Interval(</span><br><span class="line">          <span class="number">0.6</span>, <span class="number">1.0</span>, <span class="comment">//间隔，后40%的动画时间</span></span><br><span class="line">          curve: Curves.ease,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Animation&lt;<span class="built_in">double</span>&gt; controller;</span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; height;</span><br><span class="line">  Animation&lt;EdgeInsets&gt; padding;</span><br><span class="line">  Animation&lt;Color&gt; color;</span><br><span class="line"></span><br><span class="line">  Widget _buildAnimation(BuildContext context, Widget child) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      alignment: Alignment.bottomCenter,</span><br><span class="line">      padding:padding.value ,</span><br><span class="line">      child: Container(</span><br><span class="line">        color: color.value,</span><br><span class="line">        width: <span class="number">50.0</span>,</span><br><span class="line">        height: height.value,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> AnimatedBuilder(</span><br><span class="line">      builder: _buildAnimation,</span><br><span class="line">      animation: controller,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StaggerAnimation</code>中定义了三个动画，分别是对<code>Container</code>的<code>height</code>、<code>color</code>、<code>padding</code>属性设置的动画，然后通过<code>Interval</code>来为每个动画指定在整个动画过程中的起始点和终点。下面我们来实现启动动画的路由：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StaggerRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _StaggerRouteState createState() =&gt; _StaggerRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_StaggerRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">StaggerRoute</span>&gt; <span class="title">with</span> <span class="title">TickerProviderStateMixin</span> </span>&#123;</span><br><span class="line">  AnimationController _controller;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line"></span><br><span class="line">    _controller = AnimationController(</span><br><span class="line">        duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">2000</span>),</span><br><span class="line">        vsync: <span class="keyword">this</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">Null</span>&gt; _playAnimation() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//先正向执行动画</span></span><br><span class="line">      <span class="keyword">await</span> _controller.forward().orCancel;</span><br><span class="line">      <span class="comment">//再反向执行动画</span></span><br><span class="line">      <span class="keyword">await</span> _controller.reverse().orCancel;</span><br><span class="line">    &#125; on TickerCanceled &#123;</span><br><span class="line">      <span class="comment">// the animation got canceled, probably because we were disposed</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span>  GestureDetector(</span><br><span class="line">      behavior: HitTestBehavior.opaque,</span><br><span class="line">      onTap: () &#123;</span><br><span class="line">        _playAnimation();</span><br><span class="line">      &#125;,</span><br><span class="line">      child: Center(</span><br><span class="line">        child: Container(</span><br><span class="line">          width: <span class="number">300.0</span>,</span><br><span class="line">          height: <span class="number">300.0</span>,</span><br><span class="line">          decoration: BoxDecoration(</span><br><span class="line">            color: Colors.black.withOpacity(<span class="number">0.1</span>),</span><br><span class="line">            border: Border.all(</span><br><span class="line">              color:  Colors.black.withOpacity(<span class="number">0.5</span>),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          <span class="comment">//调用我们定义的交织动画Widget</span></span><br><span class="line">          child: StaggerAnimation(</span><br><span class="line">              controller: _controller</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="animatedswitcher">AnimatedSwitcher</h3>
<p>Flutter SDK中提供了一个<code>AnimatedSwitcher</code>组件，它定义了一种通用的UI切换抽象。</p>
<p><code>AnimatedSwitcher</code> 可以同时对其新、旧子元素添加显示、隐藏动画。也就是说在<code>AnimatedSwitcher</code>的子元素发生变化时，会对其旧元素和新元素，我们先看看<code>AnimatedSwitcher</code> 的定义：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AnimatedSwitcher(&#123;</span><br><span class="line">  Key key,</span><br><span class="line">  <span class="keyword">this</span>.child,</span><br><span class="line">  <span class="meta">@required</span> <span class="keyword">this</span>.duration, <span class="comment">// 新child显示动画时长</span></span><br><span class="line">  <span class="keyword">this</span>.reverseDuration,<span class="comment">// 旧child隐藏的动画时长</span></span><br><span class="line">  <span class="keyword">this</span>.switchInCurve = Curves.linear, <span class="comment">// 新child显示的动画曲线</span></span><br><span class="line">  <span class="keyword">this</span>.switchOutCurve = Curves.linear,<span class="comment">// 旧child隐藏的动画曲线</span></span><br><span class="line">  <span class="keyword">this</span>.transitionBuilder = AnimatedSwitcher.defaultTransitionBuilder, <span class="comment">// 动画构建器</span></span><br><span class="line">  <span class="keyword">this</span>.layoutBuilder = AnimatedSwitcher.defaultLayoutBuilder, <span class="comment">//布局构建器</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>当<code>AnimatedSwitcher</code>的child发生变化时（类型或Key不同），旧child会执行隐藏动画，新child会执行执行显示动画。究竟执行何种动画效果则由<code>transitionBuilder</code>参数决定，该参数接受一个<code>AnimatedSwitcherTransitionBuilder</code>类型的builder，定义如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> AnimatedSwitcherTransitionBuilder =</span><br><span class="line">  Widget <span class="built_in">Function</span>(Widget child, Animation&lt;<span class="built_in">double</span>&gt; animation);</span><br></pre></td></tr></table></figure>
<p>该<code>builder</code>在<code>AnimatedSwitcher</code>的child切换时会分别对新、旧child绑定动画：</p>
<ol>
<li>对旧child，绑定的动画会反向执行（reverse）</li>
<li>对新child，绑定的动画会正向指向（forward）</li>
</ol>
<p>这样一下，便实现了对新、旧child的动画绑定。<code>AnimatedSwitcher</code>的默认值是<code>AnimatedSwitcher.defaultTransitionBuilder</code> ：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Widget defaultTransitionBuilder(Widget child, Animation&lt;<span class="built_in">double</span>&gt; animation) &#123;</span><br><span class="line">  <span class="keyword">return</span> FadeTransition(</span><br><span class="line">    opacity: animation,</span><br><span class="line">    child: child,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，返回了<code>FadeTransition</code>对象，也就是说默认情况，<code>AnimatedSwitcher</code>会对新旧child执行“渐隐”和“渐显”动画。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedSwitcherCounterRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">   <span class="keyword">const</span> AnimatedSwitcherCounterRoute(&#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">   <span class="meta">@override</span></span><br><span class="line">   _AnimatedSwitcherCounterRouteState createState() =&gt; _AnimatedSwitcherCounterRouteState();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">_AnimatedSwitcherCounterRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AnimatedSwitcherCounterRoute</span>&gt; </span>&#123;</span><br><span class="line">   <span class="built_in">int</span> _count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@override</span></span><br><span class="line">   Widget build(BuildContext context) &#123;</span><br><span class="line">     <span class="keyword">return</span> Center(</span><br><span class="line">       child: Column(</span><br><span class="line">         mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">         children: &lt;Widget&gt;[</span><br><span class="line">           AnimatedSwitcher(</span><br><span class="line">             duration: <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">500</span>),</span><br><span class="line">             transitionBuilder: (Widget child, Animation&lt;<span class="built_in">double</span>&gt; animation) &#123;</span><br><span class="line">               <span class="comment">//执行缩放动画</span></span><br><span class="line">               <span class="keyword">return</span> ScaleTransition(child: child, scale: animation);</span><br><span class="line">             &#125;,</span><br><span class="line">             child: Text(</span><br><span class="line">               <span class="string">'$_count'</span>,</span><br><span class="line">               <span class="comment">//显示指定key，不同的key会被认为是不同的Text，这样才能执行动画</span></span><br><span class="line">               key: ValueKey&lt;<span class="built_in">int</span>&gt;(_count),</span><br><span class="line">               style: Theme.of(context).textTheme.headline4,</span><br><span class="line">             ),</span><br><span class="line">           ),</span><br><span class="line">           RaisedButton(</span><br><span class="line">             child: <span class="keyword">const</span> Text(<span class="string">'+1'</span>,),</span><br><span class="line">             onPressed: () &#123;</span><br><span class="line">               setState(() &#123;</span><br><span class="line">                 _count += <span class="number">1</span>;</span><br><span class="line">               &#125;);</span><br><span class="line">             &#125;,</span><br><span class="line">           ),</span><br><span class="line">         ],</span><br><span class="line">       ),</span><br><span class="line">     );</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h4 id="animatedswitcher实现原理">AnimatedSwitcher实现原理</h4>
<p>实际上，<code>AnimatedSwitcher</code>的实现原理是比较简单的，我们根据<code>AnimatedSwitcher</code>的使用方式也可以猜个大概。要想实现新旧child切换动画，只需要明确两个问题：动画执行的时机是和如何对新旧child执行动画。从<code>AnimatedSwitcher</code>的使用方式我们可以看到，当child发生变化时（子widget的key和类型<strong>不</strong>同时相等则认为发生变化），则重新会重新执行<code>build</code>，然后动画开始执行。我们可以通过继承StatefulWidget来实现<code>AnimatedSwitcher</code>，具体做法是在<code>didUpdateWidget</code> 回调中判断其新旧child是否发生变化，如果发生变化，则对旧child执行反向退场（reverse）动画，对新child执行正向（forward）入场动画即可。</p>
<p>Flutter SDK中还提供了一个<code>AnimatedCrossFade</code>组件，它也可以切换两个子元素，切换过程执行渐隐渐显的动画，和<code>AnimatedSwitcher</code>不同的是<code>AnimatedCrossFade</code>是针对两个子元素，而<code>AnimatedSwitcher</code>是在一个子元素的新旧值之间切换。<code>AnimatedCrossFade</code>实现原理比较简单，也有和<code>AnimatedSwitcher</code>类似的地方。</p>
<h4 id="animatedswitcher高级用法">AnimatedSwitcher高级用法</h4>
<p>AnimatedSwitcher两个view的动画相同，方向相反的， 如果要打破这个的话需要怎么做呢？实例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySlideTransition</span> <span class="keyword">extends</span> <span class="title">AnimatedWidget</span> </span>&#123;</span><br><span class="line">  MySlideTransition(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> Animation&lt;Offset&gt; position,</span><br><span class="line">    <span class="keyword">this</span>.transformHitTests = <span class="keyword">true</span>,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">  &#125;)</span><br><span class="line">      : <span class="keyword">assert</span>(position != <span class="keyword">null</span>),</span><br><span class="line">        <span class="keyword">super</span>(key: key, listenable: position) ;</span><br><span class="line"></span><br><span class="line">  Animation&lt;Offset&gt; <span class="keyword">get</span> position =&gt; listenable;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> transformHitTests;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    Offset offset=position.value;</span><br><span class="line">    <span class="comment">//动画反向执行时，调整x偏移，实现“从左边滑出隐藏”</span></span><br><span class="line">    <span class="keyword">if</span> (position.status == AnimationStatus.reverse) &#123;</span><br><span class="line">         offset = Offset(-offset.dx, offset.dy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FractionalTranslation(</span><br><span class="line">      translation: offset,</span><br><span class="line">      transformHitTests: transformHitTests,</span><br><span class="line">      child: child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用时，将<code>SlideTransition</code>替换成<code>MySlideTransition</code>即可：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AnimatedSwitcher(</span><br><span class="line">  duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>),</span><br><span class="line">  transitionBuilder: (Widget child, Animation&lt;<span class="built_in">double</span>&gt; animation) &#123;</span><br><span class="line">    <span class="keyword">var</span> tween=Tween&lt;Offset&gt;(begin: Offset(<span class="number">1</span>, <span class="number">0</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">     <span class="keyword">return</span> MySlideTransition(</span><br><span class="line">              child: child,</span><br><span class="line">              position: tween.animate(animation),</span><br><span class="line">              );</span><br><span class="line">  &#125;,</span><br><span class="line">  ...<span class="comment">//省略</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="slidetransitionx">SlideTransitionX</h4>
<p>一个通用的<code>SlideTransitionX</code> 来实现这种“出入滑动动画”</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SlideTransitionX</span> <span class="keyword">extends</span> <span class="title">AnimatedWidget</span> </span>&#123;</span><br><span class="line">  SlideTransitionX(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> Animation&lt;<span class="built_in">double</span>&gt; position,</span><br><span class="line">    <span class="keyword">this</span>.transformHitTests = <span class="keyword">true</span>,</span><br><span class="line">    <span class="keyword">this</span>.direction = AxisDirection.down,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">  &#125;)</span><br><span class="line">      : <span class="keyword">assert</span>(position != <span class="keyword">null</span>),</span><br><span class="line">        <span class="keyword">super</span>(key: key, listenable: position) &#123;</span><br><span class="line">    <span class="comment">// 偏移在内部处理      </span></span><br><span class="line">    <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">      <span class="keyword">case</span> AxisDirection.up:</span><br><span class="line">        _tween = Tween(begin: Offset(<span class="number">0</span>, <span class="number">1</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> AxisDirection.right:</span><br><span class="line">        _tween = Tween(begin: Offset(<span class="number">-1</span>, <span class="number">0</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> AxisDirection.down:</span><br><span class="line">        _tween = Tween(begin: Offset(<span class="number">0</span>, <span class="number">-1</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> AxisDirection.left:</span><br><span class="line">        _tween = Tween(begin: Offset(<span class="number">1</span>, <span class="number">0</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> position =&gt; listenable;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> transformHitTests;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//退场（出）方向</span></span><br><span class="line">  <span class="keyword">final</span> AxisDirection direction;</span><br><span class="line"></span><br><span class="line">  Tween&lt;Offset&gt; _tween;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    Offset offset = _tween.evaluate(position);</span><br><span class="line">    <span class="keyword">if</span> (position.status == AnimationStatus.reverse) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (direction) &#123;</span><br><span class="line">        <span class="keyword">case</span> AxisDirection.up:</span><br><span class="line">          offset = Offset(offset.dx, -offset.dy);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AxisDirection.right:</span><br><span class="line">          offset = Offset(-offset.dx, offset.dy);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AxisDirection.down:</span><br><span class="line">          offset = Offset(offset.dx, -offset.dy);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AxisDirection.left:</span><br><span class="line">          offset = Offset(-offset.dx, offset.dy);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> FractionalTranslation(</span><br><span class="line">      translation: offset,</span><br><span class="line">      transformHitTests: transformHitTests,</span><br><span class="line">      child: child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在如果我们想实现各种“滑动出入动画”便非常容易，只需给<code>direction</code>传递不同的方向值即可，比如要实现“上入下出”，则：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">AnimatedSwitcher(</span><br><span class="line">  duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>),</span><br><span class="line">  transitionBuilder: (Widget child, Animation&lt;<span class="built_in">double</span>&gt; animation) &#123;</span><br><span class="line">    <span class="keyword">var</span> tween=Tween&lt;Offset&gt;(begin: Offset(<span class="number">1</span>, <span class="number">0</span>), end: Offset(<span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line">     <span class="keyword">return</span> SlideTransitionX(</span><br><span class="line">              child: child,</span><br><span class="line">                       direction: AxisDirection.down, <span class="comment">//上入下出</span></span><br><span class="line">              position: animation,</span><br><span class="line">              );</span><br><span class="line">  &#125;,</span><br><span class="line">  ...<span class="comment">//省略其余代码</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="动画过渡组件">动画过渡组件</h3>
<p>将在Widget属性发生变化时会执行过渡动画的组件统称为”动画过渡组件“，而动画过渡组件最明显的一个特征就是它会在内部自管理<code>AnimationController</code>。</p>
<h4 id="自定义动画过渡组件">自定义动画过渡组件</h4>
<p>我们要实现一个<code>AnimatedDecoratedBox</code>，它可以在<code>decoration</code>属性发生变化时，从旧状态变成新状态的过程可以执行一个过渡动画。根据前面所学的知识，我们实现了一个<code>AnimatedDecoratedBox1</code>组件：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedDecoratedBox1</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  AnimatedDecoratedBox1(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.decoration,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">    <span class="keyword">this</span>.curve = Curves.linear,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.duration,</span><br><span class="line">    <span class="keyword">this</span>.reverseDuration,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> BoxDecoration decoration;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Duration</span> duration;</span><br><span class="line">  <span class="keyword">final</span> Curve curve;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">Duration</span> reverseDuration;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _AnimatedDecoratedBox1State createState() =&gt; _AnimatedDecoratedBox1State();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnimatedDecoratedBox1State</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AnimatedDecoratedBox1</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  AnimationController <span class="keyword">get</span> controller =&gt; _controller;</span><br><span class="line">  AnimationController _controller;</span><br><span class="line"></span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; <span class="keyword">get</span> animation =&gt; _animation;</span><br><span class="line">  Animation&lt;<span class="built_in">double</span>&gt; _animation;</span><br><span class="line"></span><br><span class="line">  DecorationTween _tween;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> AnimatedBuilder(</span><br><span class="line">      animation: _animation,</span><br><span class="line">      builder: (context, child)&#123;</span><br><span class="line">        <span class="keyword">return</span> DecoratedBox(</span><br><span class="line">          decoration: _tween.animate(_animation).value,</span><br><span class="line">          child: child,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">      child: widget.child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _controller = AnimationController(</span><br><span class="line">      duration: widget.duration,</span><br><span class="line">      reverseDuration: widget.reverseDuration,</span><br><span class="line">      vsync: <span class="keyword">this</span>,</span><br><span class="line">    );</span><br><span class="line">    _tween = DecorationTween(begin: widget.decoration);</span><br><span class="line">    _updateCurve();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _updateCurve() &#123;</span><br><span class="line">    <span class="keyword">if</span> (widget.curve != <span class="keyword">null</span>)</span><br><span class="line">      _animation = CurvedAnimation(parent: _controller, curve: widget.curve);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      _animation = _controller;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didUpdateWidget(AnimatedDecoratedBox1 oldWidget) &#123;</span><br><span class="line">    <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">    <span class="keyword">if</span> (widget.curve != oldWidget.curve)</span><br><span class="line">      _updateCurve();</span><br><span class="line">    _controller.duration = widget.duration;</span><br><span class="line">    _controller.reverseDuration = widget.reverseDuration;</span><br><span class="line">    <span class="keyword">if</span>(widget.decoration!= (_tween.end ?? _tween.begin))&#123;</span><br><span class="line">      _tween</span><br><span class="line">        ..begin = _tween.evaluate(_animation)</span><br><span class="line">        ..end = widget.decoration;</span><br><span class="line">      _controller</span><br><span class="line">        ..value = <span class="number">0.0</span></span><br><span class="line">        ..forward();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    _controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来使用<code>AnimatedDecoratedBox1</code>来实现按钮点击后背景色从蓝色过渡到红色的效果：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Color _decorationColor = Colors.blue;</span><br><span class="line"><span class="keyword">var</span> duration = <span class="built_in">Duration</span>(seconds: <span class="number">1</span>);</span><br><span class="line">...<span class="comment">//省略无关代码</span></span><br><span class="line">AnimatedDecoratedBox(</span><br><span class="line">  duration: duration,</span><br><span class="line">  decoration: BoxDecoration(color: _decorationColor),</span><br><span class="line">  child: FlatButton(</span><br><span class="line">    onPressed: () &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _decorationColor = Colors.red;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    child: Text(</span><br><span class="line">      <span class="string">"AnimatedDecoratedBox"</span>,</span><br><span class="line">      style: TextStyle(color: Colors.white),</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>点击后，按钮背景色会从蓝色向红色过渡，图9-9是过渡过程中的一帧，有点偏紫色，整个过渡动画结束后背景会变为红色。</p>
<p>上面的代码虽然实现了我们期望的功能，但是代码却比较复杂。稍加思考后，我们就可以发现，<code>AnimationController</code>的管理以及Tween更新部分的代码都是可以抽象出来的，如果我们这些通用逻辑封装成基类，那么要实现动画过渡组件只需要继承这些基类，然后定制自身不同的代码（比如动画每一帧的构建方法）即可，这样将会简化代码。</p>
<p>为了方便开发者来实现动画过渡组件的封装，Flutter提供了一个<code>ImplicitlyAnimatedWidget</code>抽象类，它继承自StatefulWidget，同时提供了一个对应的<code>ImplicitlyAnimatedWidgetState</code>类，<code>AnimationController</code>的管理就在<code>ImplicitlyAnimatedWidgetState</code>类中。开发者如果要封装动画，只需要分别继承<code>ImplicitlyAnimatedWidget</code>和<code>ImplicitlyAnimatedWidgetState</code>类即可，下面我们演示一下具体如何实现。</p>
<p>我们需要分两步实现：</p>
<ol>
<li>
<p>继承<code>ImplicitlyAnimatedWidget</code>类。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedDecoratedBox</span> <span class="keyword">extends</span> <span class="title">ImplicitlyAnimatedWidget</span> </span>&#123;</span><br><span class="line">  AnimatedDecoratedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.decoration,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">    Curve curve = Curves.linear, <span class="comment">//动画曲线</span></span><br><span class="line">    <span class="meta">@required</span> <span class="built_in">Duration</span> duration, <span class="comment">// 正向动画执行时长</span></span><br><span class="line">    <span class="built_in">Duration</span> reverseDuration, <span class="comment">// 反向动画执行时长</span></span><br><span class="line">  &#125;) : <span class="keyword">super</span>(</span><br><span class="line">          key: key,</span><br><span class="line">          curve: curve,</span><br><span class="line">          duration: duration,</span><br><span class="line">          reverseDuration: reverseDuration,</span><br><span class="line">        );</span><br><span class="line">  <span class="keyword">final</span> BoxDecoration decoration;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _AnimatedDecoratedBoxState createState() &#123;</span><br><span class="line">    <span class="keyword">return</span> _AnimatedDecoratedBoxState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>curve</code>、<code>duration</code>、<code>reverseDuration</code>三个属性在<code>ImplicitlyAnimatedWidget</code>中已定义。 可以看到<code>AnimatedDecoratedBox</code>类和普通继承自<code>StatefulWidget</code>的类没有什么不同。</p>
</li>
<li>
<p>State类继承自<code>AnimatedWidgetBaseState</code>（该类继承自<code>ImplicitlyAnimatedWidgetState</code>类）。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnimatedDecoratedBoxState</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AnimatedWidgetBaseState</span>&lt;<span class="title">AnimatedDecoratedBox</span>&gt; </span>&#123;</span><br><span class="line">  DecorationTween _decoration; <span class="comment">//定义一个Tween</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> DecoratedBox(</span><br><span class="line">      decoration: _decoration.evaluate(animation),</span><br><span class="line">      child: widget.child,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> forEachTween(visitor) &#123;</span><br><span class="line">    <span class="comment">// 在需要更新Tween时，基类会调用此方法</span></span><br><span class="line">    _decoration = visitor(_decoration, widget.decoration,</span><br><span class="line">        (value) =&gt; DecorationTween(begin: value));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们实现了<code>build</code>和<code>forEachTween</code>两个方法。在动画执行过程中，每一帧都会调用<code>build</code>方法（调用逻辑在<code>ImplicitlyAnimatedWidgetState</code>中），所以在<code>build</code>方法中我们需要构建每一帧的<code>DecoratedBox</code>状态，因此得算出每一帧的<code>decoration</code> 状态，这个我们可以通过<code>_decoration.evaluate(animation)</code> 来算出，其中<code>animation</code>是<code>ImplicitlyAnimatedWidgetState</code>基类中定义的对象，<code>_decoration</code>是我们自定义的一个<code>DecorationTween</code>类型的对象，那么现在的问题就是它是在什么时候被赋值的呢？要回答这个问题，我们就得搞清楚什么时候需要对<code>_decoration</code>赋值。我们知道<code>_decoration</code>是一个Tween，而Tween的主要职责就是定义动画的起始状态（begin）和终止状态(end)。对于<code>AnimatedDecoratedBox</code>来说，<code>decoration</code>的终止状态就是用户传给它的值，而起始状态是不确定的，有以下两种情况：</p>
<ol>
<li><code>AnimatedDecoratedBox</code>首次build，此时直接将其<code>decoration</code>值置为起始状态，即<code>_decoration</code>值为<code>DecorationTween(begin: decoration)</code> 。</li>
<li><code>AnimatedDecoratedBox</code>的<code>decoration</code>更新时，则起始状态为<code>_decoration.animate(animation)</code>，即<code>_decoration</code>值为<code>DecorationTween(begin: _decoration.animate(animation)，end:decoration)</code>。</li>
</ol>
</li>
</ol>
<p>现在<code>forEachTween</code>的作用就很明显了，它正是用于来更新Tween的初始值的，在上述两种情况下会被调用，而开发者只需重写此方法，并在此方法中更新Tween的起始状态值即可。而一些更新的逻辑被屏蔽在了<code>visitor</code>回调，我们只需要调用它并给它传递正确的参数即可，<code>visitor</code>方法签名如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tween visitor(</span><br><span class="line">  Tween&lt;<span class="keyword">dynamic</span>&gt; tween, <span class="comment">//当前的tween，第一次调用为null</span></span><br><span class="line">  <span class="keyword">dynamic</span> targetValue, <span class="comment">// 终止状态</span></span><br><span class="line">  TweenConstructor&lt;<span class="keyword">dynamic</span>&gt; constructor，<span class="comment">//Tween构造器，在上述三种情况下会被调用以更新tween</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>可以看到，通过继承<code>ImplicitlyAnimatedWidget</code>和<code>ImplicitlyAnimatedWidgetState</code>类可以快速的实现动画过渡组件的封装，这和我们纯手工实现相比，代码简化了很多。</p>
<h4 id="动画过渡组件的反向动画">动画过渡组件的反向动画</h4>
<p>在使用动画过渡组件，我们只需要在改变一些属性值后重新build组件即可，所以要实现状态反向过渡，只需要将前后状态值互换即可实现，这本来是不需要再浪费笔墨的。但是<code>ImplicitlyAnimatedWidget</code>构造函数中却有一个<code>reverseDuration</code>属性用于设置反向动画的执行时长，这貌似在告诉读者<code>ImplicitlyAnimatedWidget</code>本身也提供了执行反向动画的接口，于是笔者查看了<code>ImplicitlyAnimatedWidgetState</code>源码并未发现有执行反向动画的接口，唯一有用的是它暴露了控制动画的<code>controller</code>。所以如果要让<code>reverseDuration</code>生效，我们只能先获取<code>controller</code>，然后再通过<code>controller.reverse()</code>来启动反向动画，比如我们在上面示例的基础上实现一个循环的点击背景颜色变换效果，要求从蓝色变为红色时动画执行时间为400ms，从红变蓝为2s，如果要使<code>reverseDuration</code>生效，我们需要这么做：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">AnimatedDecoratedBox(</span><br><span class="line">  duration: <span class="built_in">Duration</span>( milliseconds: <span class="number">400</span>),</span><br><span class="line">  decoration: BoxDecoration(color: _decorationColor),</span><br><span class="line">  reverseDuration: <span class="built_in">Duration</span>(seconds: <span class="number">2</span>),</span><br><span class="line">  child: Builder(builder: (context) &#123;</span><br><span class="line">    <span class="keyword">return</span> FlatButton(</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        <span class="keyword">if</span> (_decorationColor == Colors.red) &#123;</span><br><span class="line">          ImplicitlyAnimatedWidgetState _state =</span><br><span class="line">              context.findAncestorStateOfType&lt;ImplicitlyAnimatedWidgetState&gt;();</span><br><span class="line">           <span class="comment">// 通过controller来启动反向动画</span></span><br><span class="line">          _state.controller.reverse().then((e) &#123;</span><br><span class="line">            <span class="comment">// 经验证必须调用setState来触发rebuild，否则状态同步会有问题</span></span><br><span class="line">            setState(() &#123;</span><br><span class="line">              _decorationColor = Colors.blue;</span><br><span class="line">            &#125;);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          setState(() &#123;</span><br><span class="line">            _decorationColor = Colors.red;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      child: Text(</span><br><span class="line">        <span class="string">"AnimatedDecoratedBox toggle"</span>,</span><br><span class="line">        style: TextStyle(color: Colors.white),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>上面的代码实际上是非常糟糕且没必要的，它需要我们了解<code>ImplicitlyAnimatedWidgetState</code>内部实现，并且要手动去启动反向动画。我们完全可以通过如下代码实现相同的效果：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">AnimatedDecoratedBox(</span><br><span class="line">  duration: <span class="built_in">Duration</span>(</span><br><span class="line">      milliseconds: _decorationColor == Colors.red ? <span class="number">400</span> : <span class="number">2000</span>),</span><br><span class="line">  decoration: BoxDecoration(color: _decorationColor),</span><br><span class="line">  child: Builder(builder: (context) &#123;</span><br><span class="line">    <span class="keyword">return</span> FlatButton(</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          _decorationColor = _decorationColor == Colors.blue</span><br><span class="line">              ? Colors.red</span><br><span class="line">              : Colors.blue;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      child: Text(</span><br><span class="line">        <span class="string">"AnimatedDecoratedBox toggle"</span>,</span><br><span class="line">        style: TextStyle(color: Colors.white),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这样的代码是不是优雅的多！那么现在问题来了，为什么<code>ImplicitlyAnimatedWidgetState</code>要提供一个<code>reverseDuration</code>参数呢？笔者仔细研究了<code>ImplicitlyAnimatedWidgetState</code>的实现，发现唯一的解释就是该参数并非是给<code>ImplicitlyAnimatedWidgetState</code>用的，而是给子类用的！原因正如我们前面说的，要使<code>reverseDuration</code> 有用就必须得获取<code>controller</code> 属性来手动启动反向动画，<code>ImplicitlyAnimatedWidgetState</code>中的<code>controller</code> 属性是一个保护属性，定义如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@protected</span></span><br><span class="line"> AnimationController <span class="keyword">get</span> controller =&gt; _controller;</span><br></pre></td></tr></table></figure>
<p>而保护属性原则上只应该在子类中使用，而不应该像上面示例代码一样在外部使用。综上，我们可以得出两条结论：</p>
<ol>
<li>
<p>使用动画过渡组件时如果需要执行反向动画的场景，应尽量使用状态互换的方法，而不应该通过获取<code>ImplicitlyAnimatedWidgetState</code>中<code>controller</code>的方式。</p>
</li>
<li>
<p>如果我们自定义的动画过渡组件用不到<code>reverseDuration</code> ，那么最好就不要暴露此参数，比如我们上面自定义的<code>AnimatedDecoratedBox</code>定义中就可以去除<code>reverseDuration</code> 可选参数，如：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedDecoratedBox</span> <span class="keyword">extends</span> <span class="title">ImplicitlyAnimatedWidget</span> </span>&#123;</span><br><span class="line">  AnimatedDecoratedBox(&#123;</span><br><span class="line">    Key key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.decoration,</span><br><span class="line">    <span class="keyword">this</span>.child,</span><br><span class="line">    Curve curve = Curves.linear,</span><br><span class="line">    <span class="meta">@required</span> <span class="built_in">Duration</span> duration,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(</span><br><span class="line">          key: key,</span><br><span class="line">          curve: curve,</span><br><span class="line">          duration: duration,</span><br><span class="line">        );</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="flutter预置的动画过渡组件">Flutter预置的动画过渡组件</h4>
<p>Flutter SDK中也预置了很多动画过渡组件，实现方式和大都和<code>AnimatedDecoratedBox</code>差不多，如表9-1所示：</p>
<table>
<thead>
<tr>
<th>组件名</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>AnimatedPadding</td>
<td>在padding发生变化时会执行过渡动画到新状态</td>
</tr>
<tr>
<td>AnimatedPositioned</td>
<td>配合Stack一起使用，当定位状态发生变化时会执行过渡动画到新的状态。</td>
</tr>
<tr>
<td>AnimatedOpacity</td>
<td>在透明度opacity发生变化时执行过渡动画到新状态</td>
</tr>
<tr>
<td>AnimatedAlign</td>
<td>当<code>alignment</code>发生变化时会执行过渡动画到新的状态。</td>
</tr>
<tr>
<td>AnimatedContainer</td>
<td>当Container属性发生变化时会执行过渡动画到新的状态。</td>
</tr>
<tr>
<td>AnimatedDefaultTextStyle</td>
<td>当字体样式发生变化时，子组件中继承了该样式的文本组件会动态过渡到新样式。</td>
</tr>
</tbody>
</table>
<p>下面我们通过一个示例来感受一下这些预置的动画过渡组件效果：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedWidgetsTest</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _AnimatedWidgetsTestState createState() =&gt; _AnimatedWidgetsTestState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnimatedWidgetsTestState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AnimatedWidgetsTest</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> _padding = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">var</span> _align = Alignment.topRight;</span><br><span class="line">  <span class="built_in">double</span> _height = <span class="number">100</span>;</span><br><span class="line">  <span class="built_in">double</span> _left = <span class="number">0</span>;</span><br><span class="line">  Color _color = Colors.red;</span><br><span class="line">  TextStyle _style = TextStyle(color: Colors.black);</span><br><span class="line">  Color _decorationColor = Colors.blue;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> duration = <span class="built_in">Duration</span>(seconds: <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> SingleChildScrollView(</span><br><span class="line">      child: Column(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          RaisedButton(</span><br><span class="line">            onPressed: () &#123;</span><br><span class="line">              setState(() &#123;</span><br><span class="line">                _padding = <span class="number">20</span>;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">            child: AnimatedPadding(</span><br><span class="line">              duration: duration,</span><br><span class="line">              padding: EdgeInsets.all(_padding),</span><br><span class="line">              child: Text(<span class="string">"AnimatedPadding"</span>),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          SizedBox(</span><br><span class="line">            height: <span class="number">50</span>,</span><br><span class="line">            child: Stack(</span><br><span class="line">              children: &lt;Widget&gt;[</span><br><span class="line">                AnimatedPositioned(</span><br><span class="line">                  duration: duration,</span><br><span class="line">                  left: _left,</span><br><span class="line">                  child: RaisedButton(</span><br><span class="line">                    onPressed: () &#123;</span><br><span class="line">                      setState(() &#123;</span><br><span class="line">                        _left = <span class="number">100</span>;</span><br><span class="line">                      &#125;);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    child: Text(<span class="string">"AnimatedPositioned"</span>),</span><br><span class="line">                  ),</span><br><span class="line">                )</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          Container(</span><br><span class="line">            height: <span class="number">100</span>,</span><br><span class="line">            color: Colors.grey,</span><br><span class="line">            child: AnimatedAlign(</span><br><span class="line">              duration: duration,</span><br><span class="line">              alignment: _align,</span><br><span class="line">              child: RaisedButton(</span><br><span class="line">                onPressed: () &#123;</span><br><span class="line">                  setState(() &#123;</span><br><span class="line">                    _align = Alignment.center;</span><br><span class="line">                  &#125;);</span><br><span class="line">                &#125;,</span><br><span class="line">                child: Text(<span class="string">"AnimatedAlign"</span>),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          AnimatedContainer(</span><br><span class="line">            duration: duration,</span><br><span class="line">            height: _height,</span><br><span class="line">            color: _color,</span><br><span class="line">            child: FlatButton(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                  _height = <span class="number">150</span>;</span><br><span class="line">                  _color = Colors.blue;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Text(</span><br><span class="line">                <span class="string">"AnimatedContainer"</span>,</span><br><span class="line">                style: TextStyle(color: Colors.white),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">          AnimatedDefaultTextStyle(</span><br><span class="line">            child: GestureDetector(</span><br><span class="line">              child: Text(<span class="string">"hello world"</span>),</span><br><span class="line">              onTap: () &#123;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                  _style = TextStyle(</span><br><span class="line">                    color: Colors.blue,</span><br><span class="line">                    decorationStyle: TextDecorationStyle.solid,</span><br><span class="line">                    decorationColor: Colors.blue,</span><br><span class="line">                  );</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">            ),</span><br><span class="line">            style: _style,</span><br><span class="line">            duration: duration,</span><br><span class="line">          ),</span><br><span class="line">          AnimatedDecoratedBox(</span><br><span class="line">            duration: duration,</span><br><span class="line">            decoration: BoxDecoration(color: _decorationColor),</span><br><span class="line">            child: FlatButton(</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                  _decorationColor = Colors.red;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Text(</span><br><span class="line">                <span class="string">"AnimatedDecoratedBox"</span>,</span><br><span class="line">                style: TextStyle(color: Colors.white),</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          )</span><br><span class="line">        ].map((e) &#123;</span><br><span class="line">          <span class="keyword">return</span> Padding(</span><br><span class="line">            padding: EdgeInsets.symmetric(vertical: <span class="number">16</span>),</span><br><span class="line">            child: e,</span><br><span class="line">          );</span><br><span class="line">        &#125;).toList(),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/Flutter/Flutter入门：自定义组件和事件/" data-toggle="tooltip" data-placement="top" title="Flutter入门：自定义组件和事件">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/Flutter/Flutter入门：路由、包和资源/" data-toggle="tooltip" data-placement="top" title="Flutter入门：路由、包和资源">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                    <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                    <!--  css & js -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    <style>
      span.toc-nav-number{
        display: none
      }
    </style>
  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#功能型组件"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">&#x529F;&#x80FD;&#x578B;&#x7EC4;&#x4EF6;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#导航返回拦截"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">&#x5BFC;&#x822A;&#x8FD4;&#x56DE;&#x62E6;&#x622A;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#数据共享inheritedwidget"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">&#x6570;&#x636E;&#x5171;&#x4EAB;&#xFF08;InheritedWidget&#xFF09;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#didchangedependencies"><span class="toc-nav-number">1.2.1.</span> <span class="toc-nav-text">didChangeDependencies</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#跨组件状态共享provider"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">&#x8DE8;&#x7EC4;&#x4EF6;&#x72B6;&#x6001;&#x5171;&#x4EAB;&#xFF08;Provider&#xFF09;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#颜色和主题"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">&#x989C;&#x8272;&#x548C;&#x4E3B;&#x9898;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#颜色"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">&#x989C;&#x8272;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#materialcolor"><span class="toc-nav-number">1.4.1.1.</span> <span class="toc-nav-text">MaterialColor</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#theme"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">Theme</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#异步ui更新"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">&#x5F02;&#x6B65;UI&#x66F4;&#x65B0;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#futurebuilder"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">FutureBuilder</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#streambuilder"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">StreamBuilder</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#对话框"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">&#x5BF9;&#x8BDD;&#x6846;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#alertdialog"><span class="toc-nav-number">1.6.1.</span> <span class="toc-nav-text">AlertDialog</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#simpledialog"><span class="toc-nav-number">1.6.2.</span> <span class="toc-nav-text">SimpleDialog</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#dialog"><span class="toc-nav-number">1.6.3.</span> <span class="toc-nav-text">Dialog</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#对话框动画及遮罩"><span class="toc-nav-number">1.6.4.</span> <span class="toc-nav-text">&#x5BF9;&#x8BDD;&#x6846;&#x52A8;&#x753B;&#x53CA;&#x906E;&#x7F69;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#对话框实现原理"><span class="toc-nav-number">1.6.5.</span> <span class="toc-nav-text">&#x5BF9;&#x8BDD;&#x6846;&#x5B9E;&#x73B0;&#x539F;&#x7406;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#对话框状态管理"><span class="toc-nav-number">1.6.6.</span> <span class="toc-nav-text">&#x5BF9;&#x8BDD;&#x6846;&#x72B6;&#x6001;&#x7BA1;&#x7406;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#其它类型的对话框"><span class="toc-nav-number">1.6.7.</span> <span class="toc-nav-text">&#x5176;&#x5B83;&#x7C7B;&#x578B;&#x7684;&#x5BF9;&#x8BDD;&#x6846;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#底部菜单列表"><span class="toc-nav-number">1.6.7.1.</span> <span class="toc-nav-text">&#x5E95;&#x90E8;&#x83DC;&#x5355;&#x5217;&#x8868;</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#loading框"><span class="toc-nav-number">1.6.7.2.</span> <span class="toc-nav-text">Loading&#x6846;</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#日历选择"><span class="toc-nav-number">1.6.7.3.</span> <span class="toc-nav-text">&#x65E5;&#x5386;&#x9009;&#x62E9;</span></a></li></ol></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#动画"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">&#x52A8;&#x753B;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#animation"><span class="toc-nav-number">2.0.1.</span> <span class="toc-nav-text">Animation</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#动画通知"><span class="toc-nav-number">2.0.2.</span> <span class="toc-nav-text">&#x52A8;&#x753B;&#x901A;&#x77E5;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#curve"><span class="toc-nav-number">2.0.3.</span> <span class="toc-nav-text">Curve</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#animationcontroller"><span class="toc-nav-number">2.0.4.</span> <span class="toc-nav-text">AnimationController</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ticker"><span class="toc-nav-number">2.0.5.</span> <span class="toc-nav-text">Ticker</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tween"><span class="toc-nav-number">2.0.6.</span> <span class="toc-nav-text">Tween</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#tweenanimate"><span class="toc-nav-number">2.0.7.</span> <span class="toc-nav-text">Tween.animate</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#使用animatedwidget简化"><span class="toc-nav-number">2.0.8.</span> <span class="toc-nav-text">&#x4F7F;&#x7528;AnimatedWidget&#x7B80;&#x5316;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#用animatedbuilder重构"><span class="toc-nav-number">2.0.9.</span> <span class="toc-nav-text">&#x7528;AnimatedBuilder&#x91CD;&#x6784;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#动画状态监听"><span class="toc-nav-number">2.0.10.</span> <span class="toc-nav-text">&#x52A8;&#x753B;&#x72B6;&#x6001;&#x76D1;&#x542C;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#路由切换动画"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">&#x8DEF;&#x7531;&#x5207;&#x6362;&#x52A8;&#x753B;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#hero动画"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">Hero&#x52A8;&#x753B;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#示例"><span class="toc-nav-number">2.2.1.</span> <span class="toc-nav-text">&#x793A;&#x4F8B;</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#交织动画"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">&#x4EA4;&#x7EC7;&#x52A8;&#x753B;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#示例"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">&#x793A;&#x4F8B;</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#animatedswitcher"><span class="toc-nav-number">2.5.</span> <span class="toc-nav-text">AnimatedSwitcher</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#animatedswitcher实现原理"><span class="toc-nav-number">2.5.1.</span> <span class="toc-nav-text">AnimatedSwitcher&#x5B9E;&#x73B0;&#x539F;&#x7406;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#animatedswitcher高级用法"><span class="toc-nav-number">2.5.2.</span> <span class="toc-nav-text">AnimatedSwitcher&#x9AD8;&#x7EA7;&#x7528;&#x6CD5;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#slidetransitionx"><span class="toc-nav-number">2.5.3.</span> <span class="toc-nav-text">SlideTransitionX</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#动画过渡组件"><span class="toc-nav-number">2.6.</span> <span class="toc-nav-text">&#x52A8;&#x753B;&#x8FC7;&#x6E21;&#x7EC4;&#x4EF6;</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#自定义动画过渡组件"><span class="toc-nav-number">2.6.1.</span> <span class="toc-nav-text">&#x81EA;&#x5B9A;&#x4E49;&#x52A8;&#x753B;&#x8FC7;&#x6E21;&#x7EC4;&#x4EF6;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#动画过渡组件的反向动画"><span class="toc-nav-number">2.6.2.</span> <span class="toc-nav-text">&#x52A8;&#x753B;&#x8FC7;&#x6E21;&#x7EC4;&#x4EF6;&#x7684;&#x53CD;&#x5411;&#x52A8;&#x753B;</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#flutter预置的动画过渡组件"><span class="toc-nav-number">2.6.3.</span> <span class="toc-nav-text">Flutter&#x9884;&#x7F6E;&#x7684;&#x52A8;&#x753B;&#x8FC7;&#x6E21;&#x7EC4;&#x4EF6;</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Flutter" title="Flutter">Flutter</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


<!-- chrome Firefox 中文锚点定位失效-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a',function(a){
            // var isChrome = window.navigator.userAgent.indexOf("Chrome") !== -1;
            // console.log(window.navigator.userAgent,isChrome)
                // if(isChrome) {
                    // console.log(a.currentTarget.outerHTML);
                    // console.log($(a.currentTarget).attr("href"));
                    //跳转到指定锚点
                    // document.getElementById(a.target.innerText.toLowerCase()).scrollIntoView(true);
                    document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
                // }
        })  
</script>


    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/earthwo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; alonealice 2021 
                    <br>
                    Theme by <a href="http://beantech.org">BeanTech</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://www.huweihuang.com">胡伟煌</a> |
                    <br> 
                    <a href="http://www.beian.miit.gov.cn">浙ICP备17033688号</a>   
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://alonealice.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'xxx';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://alonealice.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
